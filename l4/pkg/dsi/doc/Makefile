PS	= doxygenned/latex/refman.ps
FILES	= general.dox groups.dox Doxyfile Makefile
PICS	= arch.fig sig_sync_ex.fig sig_discussion.fig
NOTES	= signalling.tex
DOXYFLAG= doxygenned/built
SEARCHFLAG= doxygenned/search_built

HTMLPUBDIR=$(HOME)/public_html/local/dsi/
HTMLCGIDIR=$(HOME)/public_html/cgi-bin/

MAG_DEFAULT=1.3
MAG_arch=1

PNG	= $(PICS:.fig=.png)
EPS	= $(PICS:.fig=.eps)
EPSPAPER= datawindow.eps chain.eps measurement.eps indirect.eps
TMPDAT	= map.dat stat.dat copy.dat opt.dat

DOXYDEPS = $(FILES) $(PNG) $(EPS) Makefile

MAGNIFIER = $(firstword $(MAG_$*) $(MAG_DEFAULT))

TEXEXT	= {aux,log,dvi,ps,toc,bbl,blg}

-include Makeconf.local

help:
	@echo "Specify a target:"
	@echo "all       - same as 'make spec notes'"
	@echo "spec      - generate DSI specification (ps, html)"
	@echo "spec_nops - generate DSI specification (html only)"
	@echo "notes     - generate ps-vesion of diverse notes"
	@echo "paper     - generate ps-version of DSI-paper (may be missing)"
	@echo "pub       - generate html and install to HTMLPUBDIR ($HTMLPUBDIR)"
	@echo "clean     - delete all generated files"
	@echo "link      - create a link to store doxygenned files in /tmp"
	@echo "nolink    - remove the link generated by 'make link'"

all:	spec notes
install:

spec: $(PS)

spec_nops: $(DOXYFLAG)

paper:	paper.ps

notes: $(NOTES:.tex=.ps)

paper.dvi: $(EPSPAPER)

$(PS):	$(DOXYFLAG)
	$(MAKE) -C doxygenned/latex ps
	ln -fs $@ dsi.ps

measurement.eps: measurement.dat Makefile style.cmd datsplit
	datsplit

%.png:	%.fig Makefile
	fig2dev -L png -m $(MAGNIFIER) $< $@

%.eps:	%.fig Makefile
	fig2dev -L eps $< $@

$(DOXYFLAG): $(DOXYDEPS)
	doxygen
	touch $@

$(SEARCHFLAG): $(DOXYFLAG)
	set -e ; cd doxygenned/html ; doxytag -s search.idx 
	test -f doxygenned/html/search_dsi.cgi
	touch $@

%.ps: %.dvi Makefile
	dvips $< -o $@

#%.dvi: %.tex Makefile
#	latex $<
%.dvi:  %.tex Makefile
	( a=`cat $(@:.dvi=.version.tex)` ; let a=a+1 ; echo $$a > $(@:.dvi=.version.tmp) ; mv $(@:.dvi=.version.tmp) $(@:.dvi=.version.tex) )
	latex $<
	@echo -e "\033[34mMaking $@ because of $?\033[0m"
	@grep '\citation' $*.aux && bibtex $* || true
	@(export size=1 ; touch $*.dvi;\
	  until [ $$size -eq `ls -o $*.dvi | awk '{print $$4}'` ]; do\
	  export size=`ls -o $*.dvi | awk '{print $$4}'` ;\
	  latex $< ;\
	done)

link:
	test -L doxygenned || ( rm -rf doxygenned ; mkdir /tmp/doxygenned ; ln -s /tmp/doxygenned . )

nolink:
	test -L doxygenned && rm -rf doxygenned || true

pub:	$(DOXYFLAG) $(SEARCHFLAG)
	mkdir -p $(HTMLPUBDIR)
	cp -a doxygenned/html/* $(HTMLPUBDIR)
	mkdir -p $(HTMLCGIDIR)
	cp doxygenned/html/search_dsi.cgi $(HTMLCGIDIR)

clean:
cleanall:
	rm -rf doxygenned
	rm -f $(PNG) $(EPS) dsi.$(TEXEXT) paper.$(TEXEXT) $(EPSPAPER) $(TMPDAT)
	rm -f $(foreach base,$(NOTES:.tex=),$(base).$(TEXEXT))

.PHONY:	all spec spec_nops paper link nolink clean pub notes help
