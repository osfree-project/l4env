\documentclass[a4paper, 10pt]{article}
\usepackage[latin1]{inputenc}
\usepackage{html}
\usepackage{longtable}
\usepackage{makeidx}

%begin{latexonly}
\usepackage[a4paper,left=3cm, right=3cm]{geometry}
\usepackage[bf, hang, nooneline, small]{caption}
\usepackage{fancyvrb}
\usepackage{fancyhdr}
\usepackage{syntax}
\usepackage{array}
\usepackage{todo}
\usepackage{times}
%end{latexonly}
\begin{htmlonly}
\newcommand{\todo}[1]{(\textbf{Todo:} \marginpar{Todo}\emph{#1})}
\end{htmlonly}
\sloppy
\makeindex
\newcommand{\smallsection}[1]{\latexhtml{\subsubsection*{#1}}{\paragraph*{#1}}}

\setlength{\parindent}{0cm}
\setlength{\parskip}{0.2cm plus 0.1cm minus 0.1cm}

\begin{document}

% create a new length, which can be used as a base-length for columns
% of a table.
% arguments: #1 - the name of the length
%            #2 - number of columns of the table
%
% The length is calculated as \columnwidth-2*\tabcolsep*#2
%
\newcommand{\maketablength}[2]{%
  \newlength{#1}\setlength{#1}{-#2\tabcolsep}%
  \addtolength{#1}{#1}\addtolength{#1}{\columnwidth}%
}
\maketablength{\tabTwo}{2}
\maketablength{\tabThree}{3}
\maketablength{\tabFour}{4}

% Create a table, whose first column contains text,
% and the second column fills the rest. Both columns contain parboxes.
%
% arguments: #1 - text with the maximum width of the first column
\newlength{\descriptiontablelen}
\newlength{\descriptiontabletextlen}
\newenvironment{descriptiontable}[1]{%
  %begin{latexonly}
  \settowidth{\descriptiontabletextlen}{#1}%
  \setlength{\descriptiontablelen}{-4\tabcolsep}%
  \addtolength{\descriptiontablelen}{\columnwidth}%
  \addtolength{\descriptiontablelen}{-\descriptiontabletextlen}%
  \begin{longtable}{p{\descriptiontabletextlen}p{\descriptiontablelen}}%
  %end{latexonly}  
  \html{\begin{tabular}{tltl}}%
}{\latexhtml{\end{longtable}}{\end{tabular}}}
  
% Create a framed table, whose first column contains text,
% and the second column fills the rest. Both columns contain parboxes.
% We can use \# to end a line. In the current version, this separates
% all rows by single lines. We cheat on latex2html by preprocessing
% the .tex file substituting the \# with a \\\hline.
%
% arguments: #1 - text with the maximum width of the first column
\newenvironment{parameterlist}[1]{%
  %begin{latexonly}
  \renewcommand{\#}{\\\hline}%
  \settowidth{\descriptiontabletextlen}{\tt\small{}#1}%
  \setlength{\descriptiontablelen}{-4\tabcolsep}%
  \addtolength{\descriptiontablelen}{\columnwidth}%
  \addtolength{\descriptiontablelen}{-\descriptiontabletextlen}%
  \begin{longtable}{|>{\tt\small}p{\descriptiontabletextlen}|p{\descriptiontablelen}|}%
    \multicolumn{2}{r}{next page \dots}\\\endfoot%
    \multicolumn{2}{l}{\dots{} continued from last page}\\\endhead%
    \endfirsthead%
    \endlastfoot%
  %end{latexonly}  
  \html{\begin{tabular}{>{\tt{}}ll}}%
  \hline%
}{%
  %begin{latexonly}
   \end{longtable}%
  %end{latexonly}
  \html{\end{tabular}}}%

%begin{latexonly}
% We use the '§' character to write a '$' without entering math-mode
\DeclareInputText{167}{\$}

% We use '«' and '»' to begin and end code-pieces
\renewcommand{\guillemotleft}{\begin{code}{}}
\renewcommand{\guillemotright}{\end{code}}

\pagestyle{fancy}

% verbatim handling to include other files. Uses fancyvrb.
\newcommand{\vfontsize}{\small}
\newcommand{\vframe}{single}
\newcommand{\examplefile}[2]{\VerbatimInput[fontsize=\vfontsize,%
               frame=\vframe, label=#1]{#2}}
\DefineShortVerb{\|}
%end{latexonly}  
\newenvironment{code}{\begin{ttfamily}}{\end{ttfamily}}
\newcommand{\name}[1]{{\sl#1}}

\newenvironment{implemented}{\subsubsection{Implementation status}\
  \begin{description}}{\end{description}}

\newcommand{\llinux}{\mbox{L\makebox[.4\width]{$^4~$}Linux}}
\newcommand{\mukernel}{$\mu$-kernel}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%
% The story starts here.
%
% Character-encoding, we do it the following way:
%
% (Because that stupid latex2html does not support shortverb, we do
% not use the shorthand |text| to print the text verbose. This would allow
% easy writing of variables and text while disallowing line breaking.)

% For tables, we use «text», which expands to \code{text}, which expands
% to {\tt{}text}. We cheat on latex2html by preprocessing the .tex-file.
%
% During the hole text, we can use '_' to write an underscore. We use
% '§' to write a '$' in non-verbose mode.
  
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\title{Building Infrastructure for DROPS (BID) Specification}
\author{Jork Löser \qquad Ronald Aigner\\drops@os.inf.tu-dresden.de}
\date{\today}
\maketitle
\thispagestyle{empty}

\smallsection{Abstract}

To ease the writing of DROPS components, this document describes the
unified infrastructure of the DROPS source tree. It also describes
what files and macros should be used to create the Makefiles needed to
compile own components.

\smallsection{Acknowledgements}

This document is based on the work of Lukas Grützmacher, Michel
Hohmuth, Jork Löser and Lars Reuther done in 2000. Since then, Frank Mehnert
proposed a lot of functionality which is included in this document as well.

\smallsection{Availability}

This document is also available in
\latexhtml{\htmladdnormallink{HTML}{index.html}}
{\htmladdnormallink{.ps}{spec.ps} and
  \htmladdnormallink{.pdf}{spec.pdf}} format. A short abstract is
available as \htmladdnormallink{abstract.ps}{abstract.ps} and
\htmladdnormallink{abstract.pdf}{abstract.pdf}. You can download this
documentation in its various formats at
\htmladdnormallink{http://os.inf.tu-dresden.de/l4env/}
{http://os.inf.tu-dresden.de/l4env/}.

\vfill

\paragraph*{Copyright}

This documentation is \copyright2006 by Technische Universität
Dresden. This documentation is part of DROPS, being distributed under
the terms of the GNU General Public License 2. Please see the world
wide web at \htmladdnormallink{http://os.inf.tu-dresden.de/l4env/COPYING}
{http://os.inf.tu-dresden.de/l4env/COPYING}, or write to the FSF, 59~Temple
Place~\#330, Boston, MA 02111-1307, USA for details.


%begin{latexonly}
\pagebreak
{
\setcounter{tocdepth}{2}
\setlength{\parskip}{0.5ex plus 1ex minus 0.5ex}
\tableofcontents
}
%end{latexonly}

\vfill\pagebreak
\section{Source-Tree}

\latexhtml{
\begin{tabular}{|>{\tt\small}p{.4\tabTwo}|p{.6\tabTwo}|}
}{\begin{tabular}{ll}}
\hline
\bf\normalsize{}Directory/File          & \bf{}Comment     \\\hline

l4/                                     & base-directory, contains
                                         \emph{no} «Makeconf»s \\\hline

l4/kernel/                              & kernel sources \\\hline

l4/pkg/                                 & contains the packages \\\hline
(disappeared)                           & was: l4/Makeconf \\\hline
l4/mk/                                  & contains role-files (see
                                          Section \ref{sec:rolefiles}) \\\hline

l4/pkg/PKGANME/                         & DROPS-components (packages) \\\hline
l4/pkg/PKGNAME/include/                 & headers to be exported by
                                          that package \\\hline
l4/pkg/PKGNAME/idl/                     & IDL-definition \\\hline
l4/pkg/PKGNAME/\{lib, server\}/\{lib,
        src, include\}
                                        & sources \\\hline
l4/pkg/PKGNAME/{etc/, examples/,
        man/, doc/, README, TODO,
        INSTALL, COPYING}               & preferred names for
                                          according files \\\hline
l4/pkg/PKGNAME/Makefile                 & package-Makefile, there is
                                          no symlink anymore \\\hline

l4/\{bin,\,lib\}/\{x86_586/,x86_586/v2/,ia64/,\dots\} and
   l4/\{include, idl\}
                                       & Build-Installation path for
                                         the packages. These
                                         directories contain stripped
                                         versions of compiled binaries.
                                         \\\hline

\end{tabular}


\subsection{MAINTAINER files and L4Check}
\index{L4Check}
\index{MAINTAINER file}
To maintain at least a low level of code consistency in our DROPS
project, we designed the L4Check \cite{www:l4check} tool. It runs every
night and checkouts the various packages from CVS and builds them. If
the build-process fails, an email is automatically generated and sent
to the maintainer of the failing package. To define the maintainer of
a package (to be more precise, of a subdirectory), a so-called
\emph{maintainer} file is used. This is a file named «MAINTAINER»
containing lines of the following syntax:

\begin{center}
\syntax{"mailaddr" <mail address> ["," <mail address> [, ... ]]}
\end{center}

If an error occurs within the directory subtree containing the
maintainer file, a mail indicating the error will be sent to the
specified mail addresses. You can add maintainers for a specific
subdirectory tree by placing an additional maintainer file in the root
of that tree. The ``sub-maintainers'' will receive a mail in the
case of an error in their subtree. Additionally, the maintainers of
the upper directories will receive an according mail.


\subsection{Package Flags}

\paragraph*{broken}
\index{broken package flag}
If a package becomes broken for some reason, place a file named
«broken» in the top-level directory of that package and it won't be
built.

\paragraph*{obsolete}
\index{obsolete package flag}
If a package becomes outdated for some reason, place a file named
«obsolete» in the top-level directory of that package and it won't be
built.


\vfill\pagebreak
\section{Directory Roles}
\label{sec:rolefiles}

Each directory in the source-tree has a distinct task, i.e. each
directory builds special kinds of targets. This distinct task is
expressed by a role, where role is one of the following:

\begin{descriptiontable}{include:}
subdir:  & be a container for other directories and recursively build them\\
prog:    & build executable binaries \\
lib:     & build libraries \\
idl:     & translate IDL definitions into code \\
include: & hold include-files which have to be installed \\
doc:     & build documentation for the package \\
ptest:   & test the package using Fiasco-UX \\
\end{descriptiontable}

To define the role of a directory, the Makefile of that directory has
to include an according Makefile-include, the
\emph{role-file}\index{role-files}. The role-files are templates that
define rules and variables to build the proper targets. Make-variables
are used to control the behaviour of the role-files. Each Makefile
must include exactly one role-file.

To define the role of a directory, use the following code in your Makefile:
\nopagebreak

\begin{descriptiontable}{include:}
subdir:  & «include §(L4DIR)/mk/subdir.mk» \\
prog:    & «include §(L4DIR)/mk/prog.mk» \\
lib:     & «include §(L4DIR)/mk/lib.mk» \\
idl:     & «include §(L4DIR)/mk/idl.mk» \\
include: & «include §(L4DIR)/mk/include.mk» \\
doc:     & «include §(L4DIR)/mk/doc.mk» \\
ptest:   & «include §(L4DIR)/mk/runux.mk» \\
\end{descriptiontable}

\subsection*{Makeconf.local's}
\index{Makeconf.local}

The Make-variables to control the role-files are defined in various
files: The Makefile, a local «Makeconf.local», a packet-local
«Makeconf.local», a global «Makeconf.local» and a global
«Makeconf.bid.local». The local «Makeconf.local» resides within the
same directory as the Makefile, the packet-local «Makeconf.local» is
located in the top-level directory of a package, and both global
«Makeconf.local» and «Makeconf.bid.local» reside in «§(L4DIR)».

The gobal «§(L4DIR)/Makeconf.bid.local» is created by the DROPS
Configuration Tool (see Section \ref{sec:config}) when called in
«§(L4DIR)». This file is mandatory, i.e., you have to call «make
config» and configure your DROPS tree prior to compilation. In
contrast to this, the «Makeconf.local»s are optional, they are
included if they are available. Create them with a text editor.

The «Makeconf*local»'s should never be checked into the CVS, as they
are meant to define user-specific things. Additional configuration
files can be created using the DROPS Configuration Tool.

The role-files include the configuration files in the following order:
global Makeconf.bid.local, global Makeconf.local, packet-local, local.


\vfill\pagebreak
\section{DROPS Configuration Tool}
\label{sec:config}
\index{Configuration Tool}

Most role-files provide support for an interactive configuration tool,
which is derived from the \emph{config} and \emph{menuconfig} tools of
Linux. It differs in that it can be configured using environment
variables. Some minor extensions are build in too.

The configuration tool is run if the user runs ``«make config»'',
``«make txtconfig»'' or ``«make oldconfig»''. The following
parameters control the configuration tool.

{
\begin{parameterlist}{DROPSCONF_DONTINC_MK}

    DROPSCONF                   & \index{§(DROPSCONF)}%
                                  if non-empty, the configuration tool
                                  will be run for the makefile-targets
                                  \textbf{\{old,txt,\}config::}. If
                                  neither \textbf{\{old,txt,\}config},
                                  \textbf{scrub}, \textbf{clean} nor
                                  \textbf{cleanall} is within the make
                                  targets, the file
                                  «§DROPSCONF·CONFIG» is
                                  included using the -include directive.

                                  If this parameter is empty, no
                                  commands are run and no file is
                                  included. However, you can
                                  specify additional commands to be
                                  run in your own Makefile. Modifies
                                  \textbf{help::}, \textbf{clean::}
                                  and \textbf{cleanall::} rules.

                                  Default: empty, do not run the
                                  configuration tool on ``«make
                                    config»''. \#
        
    DROPSCONF_DEFCONFIG        & \index{§(DROPSCONF_DEFCONFIG)}%
                                  the default configuration file,
                                  which is used as the initial
                                  configuration.
                                  
                                  Default: «defconfig» \#

    DROPSCONF_CONFIG_IN       & \index{§(DROPSCONF_CONFIG_IN)}%
                                  the configuration definition file.
                                  
                                  Default: «config.in» \#

    DROPSCONF_CONFIG           & \index{§(DROPSCONF_CONFIG)}%
                                  the configuration file, which holds
                                  the configuration. This file is
                                  automatically build from
                                  «§DROPSCONF_DEFCONFIG» when needed.

                                  Default: «.config» \#

    DROPSCONF_CONFIG_H          & \index{§(DROPSCONF_CONFIG_H)}%
                                  the configuration header file, which
                                  is included by the source files.

                                  Default: «config.h» \#

    DROPSCONF_CONFIG_MK         & \index{§(DROPSCONF_CONFIG_MK)}%
                                  the make include file, which
                                  is included by the makefiles.

                                  Default: «Makeconf.bid.local» \#

    DROPSCONF_DONTINC_MK       & \index{§(DROPSCONF_DONTINC_MK)}%
                                  If this option is non-empty,
                                  inclusion of the make include file
                                  is supressed.

                                  Default: empty \#

    DROPSCONF_HELPFILE         & \index{§(DROPSCONF_HELPFILE)}%
                                  the file containing the option help
                                  texts.

                                  Default: «config.help» \#

    DROPSCONF_MACRO            & \index{§(DROPSCONF_MACRO)}%
                                  the macro which is defined when
                                  DROPSCONF_CONFIG_H is included.

                                  Default: «CONFIG_H_INCLUDED» \#

    DROPSCONF_TITLE            & \index{§(DROPSCONF_TITLE)}%
                                  the main title in the configuration
                                  tool.

                                  Default: ``DROPS Configuration
                                  Tool'' \#

    DROPSCONF_TOOL             & \index{§(DROPSCONF_TOOL)}%
                                  the path to the menu-driven
                                  configuration tool used for the
                                  \textbf{config::} target.

                                  Default:
                                  «§(L4DIR)/tool/config/Menu\-config»
                                  \#

    DROPSCONF_TOOL_TXT        & \index{§(DROPSCONF_TOOL_TXT)}%
                                  the path to the configuration tool
                                  used for the \textbf{txtconfig::}
                                  target.

                                  Default:
                                  «§(L4DIR)/tool/config/\-Configure»
                                  \#

    DROPSCONF_TOOL_OLD        & \index{§(DROPSCONF_TOOL_OLD)}%
                                  the path to the configuration tool
                                  used for the \textbf{oldconfig::} target.

                                  Default:
                                  «§(L4DIR)/tool/config/\-Configure -d»
                                  \#

    DROPSCONF_UNDEF           & \index{§(DROPSCONF_UNDEF)}%
                                  If nonempty, disabled boolean options
                                  won't be defined in
                                  «§(DROPSCONF_CONFIG_H)» at all. If
                                  empty, disabled options will be
                                  defined as «0». Enabled boolean
                                  options are defined as «1» always.

                                  Default: empty. \#
\end{parameterlist}
}

The configuration tool creates three files: The configuration file
(«§DROPSCONF_CONFIG»), the configuration include file
(«§DROPSCONF_CONFIG_H») and the make include file
(«§DROPSCONF_CONFIG_MK»). The first contains the configuration in a
format suitable for the config tool. The second is a standard
include-file for C files. The last contains the configuration in a
format to be included in Makefiles. Note, that it is automatically
included in your Makefile when one of the role-files is included and
if your Makefile supports configuration. The role-files ensure that
the configuration file is build appropriately. If you want to include
the configuration file in other Makefiles, make sure the configuration
file is built.

\enlargethispage*{4ex}
When using the configuration tool, the special target
\textbf{DROPSCONF_CONFIG_MK_POST_HOOK::}
\index{DROPSCONF_CONFIG_MK_POST_HOOK::} is called after generating
«§(DROPSCONF_CONFIG_MK)». You can add your own commands here, the
configuration options will already be effecive during execution.

\vfill\pagebreak
\section{Build Directories}
\label{sec:builddirs}
\index{build directories}

BID does use build-directories to contain all generated files. So your source
directory will not be modified. If you try to configure or build your L4
system without specifying a build-directory an error is issued. Simply name an
build-directory (or output directory) when calling make with the variable
«O»\index{O} set:

\begin{verbatim}
~> make O=/path/to/your/build/dir
\end{verbatim}

To create this directory and set up a basic Makefile infrastructure in this
directory you have to call first:

\begin{verbatim}
~> make O=/path/to/your/build/dir config
\end{verbatim}

\subsection{Building External Sources}
\label{sec:externalsource}

If you do have a source directory outside your regular L4 setup and want to
build this into your build directory you may do so using the
«SRC_BASE»\index{SRC_BASE} environment variable. To determine the target
location in the build directory BID requires a reference point. This reference
point is denoted by the «SRC_BASE» variable. An example:

\begin{verbatim}
L4DIR=§(HOME)/src/l4
O=§(HOME)/build-dirs/build-v2
PWD=§(HOME)/test/pkg/my-pkg
\end{verbatim}

I you want «my-pkg» to appear in the «pkg» sub-directory in the
build-directory, you would have to set «SRC_BASE» to «§(HOME)/test». Thus your
make invocation would look like this:

\begin{verbatim}
~/test/pkg/my-pkg > make O=§(HOME)/build-dirs/build-v2 \
L4DIR=§(HOME)/src/l4 SRC_BASE=../..
\end{verbatim}

\subsection{Parallel Build}
\label{sec:parallelbuild}
\index{parallel build}

While talking about building your source we might as well mention parallel
builds here. If you simply run «make -j» in your package directory, you will
notice that make will drop several dependencies (see
Section~\ref{sec:dependencies}) and then start a parallel build. This is
actually not the intended behaviour, because of course we would like to keep
the dependencies intact. Thus we must only enable parallel build where it is
appropriate, for instance, in one sub-directory containing only source files.
Therefore, we use the environment variable «PL»\index{PL} to specify the level
of parallelism. You may invoke «make» like this:

\begin{verbatim}
~/src/l4/pkg > make O=§(HOME)/build-dirs/build-v2 PL=4
\end{verbatim}

\vfill\pagebreak
\section{Dependencies}
\label{sec:dependencies}
\index{dependencies}

\subsection{Source-code dependencies}

Dependencies are built automatically. When compiling source-files into
intermediate object files, each source-file is accompanied by an
according dependency file. If the source-file is named «x», then the
dependency file is named «.x.d». Typically these dependency files
contain header files. For binary linking the same rules apply. 
Dependency files for binaries typically contain libraries. Dependency
files are deleted on ``«make cleanall»''.

For generating of dependency files, we use two methods: If the host
system provides and uses the dynamic linker \name{ld.so}, we use
\emph{libgendep} \cite{www:gendep}\index{libgendep} to build the
dependency files. libgendep uses the «LD_PRELOAD» method to overload
the «open()»- and «fopen()»-functions of libc during compilation or
linking. All files opened read-only are added to the list of
dependencies for the current target. This is a flexible solution, as
it can be used on a broad range of compilers, linkers and other tools. 
To enable this tool, set «HAVE_LDSO» (Section
\ref{sec:common-targets-opt}) to nonempty in your local configuration
files.

If the host system does not provide \name{ld.so}, we fall back to the
second method of dependency file generation: For compilation of C and
C++ files, we use \name{gcc} to generate dependency files and
postprocess those. For linking, we use a heuristic that mimics the
behavior of the linker \name{ld}. Please note, that this heuristic
does not reflect the exact behavior of the linker for efficiency
reasons and has several problems (see below). For IDL compilation with
\name{dice}, we use \name{dice} to generate according dependency files
and postprocess those.

With both methods, dependency files are created automatically and they
are used automatically. We avoid a typical error when dealing with
dependency files: If a dependency file poses a dependency of a
source-file «src.c» to an include file «inc.h», and «inc.h» is deleted
with the appropriate modification in «src.c», the build process may
fail: The make process notifies the dependency because of the
unmodified dependency file, but make does not know how to build
«inc.h» (albeit it is not needed anymore). Hence, make throws an
error. We circumvent this by adding a rule ``«inc.h:»'' to the
dependency file. The result is, that make rebuilds «src.c» if «inc.h»
disappears --- exactly what we want.

However, the fall-back method for libraries has a problem with invalid
symbolic links: If a symbolic but invalid link is found within the
library directories, this is used for the library dependencies. This
might be the wrong choice (as the actual library might appear later in
the search path), resulting in an abortion of the compilation process.

\subsection{Configuration File Dependencies}

The dependency generation also covers configuration and Makefiles. 
This is, each object file and target is made dependent on the Makefile
and on the various «Makeconf.*local»'s present in the file-system.

Information about if a configuration file is existing or not is stored
in a file named «.general.d», and this file is made dependent of the
existing files. The role-files then ensure that all objects files and
targets depend on this «.general.d».

\subsection{Package Dependencies}

To resolve inter-package dependencies basically two mechanisms are used. The
first one is an explicit notation in the «l4/pkg/Makefile»: each package is
separated into three parts: «headers», «lib», and «bin». The headers parts
consists of the «idl» and «include» subdirectories of the package. The lib
part contains the «lib» subdirectory and the bin part does contain the
«server» and «examples» subdirectories. Usually the L4 packages are  build in
the order of first building all «headers» sections, then all «lib» sections
and finally all «bin» sections. The packages belonging to the L4 Environment
are here preferred above the rest: so first all of the above steps for the L4
Environment, later the same steps for the rest.

You will find several of explicit dependencies between the parts of different
packages specified in «l4/pkg/Makefile». These are respected by make during
the build process and will ensure the correct order of building the packages.
However, this mechanism fails if a package is not present in your source tree.
Then make will silently ignore that dependency and you will probably see
errors of missing include files during compile or unresolved symbols when
linking binaries. This is where the second mechanism comes into play.

In your Makefiles you may specify the Variable
«DEPENDS_PKGS»\index{DEPENDS_PKGS} with a list of other packages that have to
be present for this package to compile. Whenever the build systems finds this
variable it will check in the «l4/pkg» directory for package directories with
that names. If a package from the list is missing in the directory, an error
is printed and the make run is aborted. Thus, you can specify inter-package
dependencies.

\vfill\pagebreak
\section{Systems, Architectures and Modes}
\label{sec:systems}

This section describes how to build for multiple architectures and for
multiple target systems.

\subsection{Definitions of Terms}

When building for multiple environments, we distinguish between the
\emph{system} and a \emph{mode}:

\begin{description}

\item [System] \index{System}%
  specifies the system environment of the target machine
  including the running \mukernel. System itself splits up into three
  parts:

  \begin{center} «<SYSTEM> = <ARCH> "_"<CPU> [ "-"<L4API> ]»\end{center}
  
  «<ARCH>» specifies the architecture of the target processor. «<CPU>»
  specifies a model of the processor in more detail. It can be used
  for certain optimizations. «<L4API>» specifies the binding of the
  \mukernel. See Table \ref{tab:systems} for a list of currently
  defined architectures, CPU types and L4 APIs.
  \index{ARCH}\index{CPU}\index{L4API}
  
  The L4API part is optional. If it is omitted, the target is assumed
  to be independent of a specific L4 binding. Each target can be
  compiled for multiple systems at the same time.

\item [Mode] \index{Mode}%
  covers the target execution environment respectively the
  C-libraries binaries should be linked against. Examples are
  \name{l4env}, \name{loader} or \name{host}. See Section
  \ref{sec:systems-modes} for a list of suggestions. Each target can
  be built/compiled for only one mode.
\end{description}

\begin{table}[htp]
\begin{center}
\begin{tabular}{|l|c|c|c|c|}\hline
        ARCH    & \underline{x86}              & arm & amd64  & ppc32 \\\hline
        CPU     & \underline{586}, 686, K6, K7 & \underline{sa}, pxa, int & 
	   \underline{k8} & \underline{750} \\\hline
        L4API   & \underline{l4v2}, l4x2, l4secv2emu & \underline{l4x0} &
	   \underline{l4v2}, l4x2 & \underline{l4x2} \\\hline
\end{tabular}
\caption{Valid values for the components of a system description.
  Defaults are underlined.}
\label{tab:systems}
\end{center}
\end{table}

In contrast to the mode, the system is visible within the directory
structure: The system of a (compiled/linked/built/installed) file is
encoded in the directory part of the name of that file. For example,
if a library is compiled for system \name{x86_586-l4v2}, its name is
«libfoo.a», it will be installed to «§(L4DIR)/lib/x86_586/l4v2/libfoo.a».
Another library «libbar.a» compiled for system
\name{x86_586}\footnote{hence, it is independent of an L4 binding}, it
will be installed to «§(L4DIR)/lib/x86_586/libbar.a». This is the case for
includes and binaries analogically. So far for the installed files.

The compilation process must respect multiple systems too: We allow to
build multiple systems at the same time from the same source-files.
Therefore, the maintainer of a package specifies the possible
systems\footnote{read below about the granularity}. In a global
configuration file (maintained by the user that compiles its tree),
all systems that should be compiled are specified.

\subsection{File System Representation}

Let us look now at a package subdirectory, containing the source-file
«pkg/foo/lib/src/foo.c». We compile for systems \name{x86_586-l4v2}
and \name{ia64-l4v2}. To distinguish between both object files, we
place them in different directories: «OBJ-<system>»:
«.../src/OBJ-x86_586-l4v2/foo.o» and «.../src/OBJ-ia64-l4v2/foo.o». As
we have a smooth migration from one target system to multiple
systems in mind, we compile \emph{always} into subdirectories,
even if we compile for only one system. Thus, we have the
structure as depicted in Figure \ref{fig:systems-package-tree}
(please, ignore the Makefiles for now).

\begin{figure}
\begin{center}\begin{minipage}{.4\columnwidth}\small\begin{verbatim}
  pkg/
   +- foo/
       +- include/
       +- lib/
       |   +- src/
       |       +- Makefile1
       |       +- Make.rules
       |       +- foo.c
       |       +- OBJ-x86_586-l4v2/
       |       |   +- Makefile2
       |       |   +- foo.o
       |       |   +- libfoo.a
       |       +- OBJ-ia64-l4v2/
       |           +- Makefile3
       |           +- foo.o
       |           +- libfoo.a
       +- server/
\end{verbatim}
\end{minipage}\end{center}
\caption{Structure of an example package}
\label{fig:systems-package-tree}
\end{figure}

\subsection{Compilation for Multiple Systems}
\label{sec:systems-compile}

Within the Makefile in the «.../src/» directory, «L4DIR» and «PKGDIR»
and the supported systems are specified. Also, either «prog.mk» or
«lib.mk» is included. During the make process, BID creates the
system-specific subdirectories with Makefiles therein. Those Makefiles
define the variables «L4DIR», «PKGDIR», «SYSTEM», «ARCH», «CPU» and
«L4API»\footnote{Note that «L4API» can be empty.}. During compilation
of C and C++ files, the preprocessor macros
SYSTEM_§(SYSTEM)\index{SYSTEM preprocessor macro},
ARCH_§(ARCH)\index{ARCH preprocessor macro},
CPUTYPE_§(CPU)\index{CPUTYPE preprocessor macro} and
L4API_§(L4API)\index{L4API preprocessor macro} will be
defined. The generated Makefiles also include either the original
Makefile in the upper directory or alternatively a separate file
«Make.rules»\index{Make.rules} if it exists within the upper
directory.

Having that separate Make.rules file might be useful, as otherwise all
definitions have to be done in that one Makefile. Note, that this
Makefile is interpreted in the src/ directory and in the
system-specific subdirectories. To prevent trouble, you can write all
the declarations meant for the src/ directory in the Makefile (this
are L4DIR, PKGDIR and the systems normally). All declarations for
generating the targets and controlling the actual build process for
one system in Make.rules. Make.rules will only be interpreted within
the subdirectories.

If immediate evaluation of variables defined in the role-files is
needed (e.g., to define rules), «§(L4DIR)/mk/*.mk» can be included in
«Make.rules». It is ensured, that the same role-file will only be
included once. If no role-file is included explicitly, it will be
automatically included after including Make.rules.


\subsection{Specifying the Systems to build}

So far, we described how to build multiple systems. No, we describe
how to specify the systems a packet can build.

Each source directory of a package specifies the target systems this
directory can be built for. The target systems are defined as a list
within the parameter «SYSTEMS»\index{§(SYSTEMS)} in the Makefile of
that source directory. The systems listed in «SYSTEMS» may have a CPU
component, but it can also be empty. The L4API in «SYSTEMS» is
optional too.

The user that compiles its L4-tree specifies the systems he wants to
build. Therefore he sets the variable
«BUILD_SYSTEMS»\index{§(BUILD_SYSTEMS)}, e.g. using the global
Makeconf.bid.local (see Section \ref{sec:config}). The systems listed
in «BUILD_SYSTEMS» always have an L4API component. The user may
specify a specific CPU for optimization purposes within the CPU
component. He may even list the same CPU architecture/L4API
combination multiple times, each time with a different CPU type, e.g.,
«x86_386-v2 x86_586-v2 x86_K7-v2».

Within a source directory, the matching systems are built: A system
matches, if it can be found in both variables «SYSTEMS» and
«BUILD_SYSTEMS». If that directory requires no specific L4 binding (no
L4API part within «SYSTEMS»), the L4API parts in «BUILD_SYSTEMS» are
ignored. The CPU parts in «BUILD_SYSTEMS» are always ignored for
matching, but if a match is found, they become part of the matching
system. More formal:

\begin{quote}
  From each item \textit{sys} specified in «BUILD_SYSTEMS» the CPU
  component is removed. Then, each (shortened) item \textit{sys} is
  matched against the list in «SYSTEMS». If an element \textit{i} of
  «SYSTEMS» can be found as a substring within \textit{sys},
  \textit{i} is added to the intersection list. If the original value
  of \textit{sys} had a CPU component, this CPU component is added to
  \textit{i} as well.
\end{quote}


Some packages built code for multiple systems and use an IDL compiler
to generate the communication stubs. The systems these packets can be
built for depend mainly on the IDL compiler. To avoid to change all
the Makefile of those packages if the IDL compiler supports more
systems, the variable «IDL_SYSTEMS»\index{§(IDL_SYSTEMS)} contains all
the systems our default IDL compiler \name{dice}\cite{dice-man} can
generate code for. A Makefile can use «SYSTEMS=§(IDL_SYSTEMS)» to
automatically build for all systems that are supported by dice.

Note that when compiling files in the «OBJ-*» subdirectories, the
contents of «§(SYSTEM)» can not necessarily be found in the §(SYSTEMS)
variable of the original Makefile, e.g. due to the added «§(ARCH)»
component. To help writing system-specific makefiles, the make
variable «§(OSYSTEM)»\index{§(OSYSTEM)} is defined by the generated
makefile. It contains that part of the «§(SYSTEMS)» variable in the
Makefile that corresponds to the current «§(SYSTEM)». Note,


\subsection{Modes}
\label{sec:systems-modes}

The following modes are defined:

\begin{descriptiontable}{l4env\_minimal}

tiny           & Minimal environment. Includes basic libc functionality from one
                 of the C libraries selected and utility functions. \\

sigma0         & Minimal L4 environment. Includes basic libc functionality like
                 tiny mode but additionally links \emph{log} and \emph{names}
	         libraries. \\

l4env          & Default mode to build L4Env applications. Sets appropriate
                 include and library paths. Also links against the L4Env
	         libraries. I/O output is printed to log. \\

l4env\_minimal & l4env mode with just write(1, ...) as I/O backend. \\

l4env\_base    & l4env mode with the libc backends: basic_io, basic_mmap,
                 mmap_util, syslog, simple_sleep, time, file_table. \\

libc           & Rather internal mode to compile C libraries \\

host           & Build an application for the host operating system. \\

l4linux        & Build hybrid applications for \llinux{}, which are normal Linux
                 applications, but are also linked against L4Env libraries. \\

\end{descriptiontable}

Deprecated modes: l4linux\_kern, l4env\_oskit06, l4env\_oskit10,
l4env\_freebsd, loader, sigma0\_oskit06, oskit10\_sigma0, 

The mode specifies which standard C library and header files are being
used, which objects for startup-code (CRT0), end-/marker-code (CRTN)
are being linked and which linker scripts are used for all this. See
Tables \ref{tab:mode-incdirs-diet}, \ref{tab:mode-incdirs-uc}, \ref{tab:mode-libdirs},
\ref{tab:mode-clibs-diet}, \ref{tab:mode-clibs-uc}, \ref{tab:mode-l4libs}, and
\ref{tab:mode-crt0ldscript} for what is determined by each mode. See Section
\ref{sec:prog.mk} and Section \ref{sec:lib.mk} for the meaning of the
variables.

%begin{latexonly}
\newenvironment{ptabtwo}{\begin{tabular}{|p{.17\tabTwo}|%
                >{\small\ttfamily\raggedright}p{.83\tabTwo}|@{}l@{}}%
}{\end{tabular}}
\newenvironment{ptabthree}[2]{\begin{tabular}{|p{.17\tabThree}|%
                 >{\small\ttfamily\raggedright}p{#1\tabThree}|%
                 >{\small\ttfamily\raggedright}p{#2\tabThree}|@{}l@{}}%
}{\end{tabular}}
%end{latexonly}
\begin{htmlonly}
\newenvironment{ptabthree}[2]{\begin{tabular}{|p|%
                >{\small\ttfamily\raggedright}p|%
                >{\small\ttfamily\raggedright}p|}}%
}{\end{tabular}}
\newenvironment{ptabtwo}{\begin{tabular}{|p|>{\small\ttfamily\raggedright}p|}%
}{\end{tabular}}
\end{htmlonly}

\begin{table}[htp]
\index{§(MODE)}\index{§(LIBCINCDIR)}%
\begin{ptabtwo}
\hline
\bf Mode        & \bf «§LIBCINCDIR» &\\\hline\hline

l4env          & -nostdinc -DUSE_DIETLIBC=y -I\{ §(L4DIR)/include/dietlibc
                 §(DROPS_STDDIR)/include/dietlibc §(GCCINCDIR) \} 
               &\\\hline

l4env\_minimal & -nostdinc -DUSE_DIETLIBC=y -I\{ §(L4DIR)/include/dietlibc
                 §(DROPS_STDDIR)/include/dietlibc §(GCCINCDIR) \} 
               &\\\hline

l4env\_base    & -nostdinc -I\{ §(L4DIR)/include/dietlibc
                 §(DROPS_STDDIR)/include/dietlibc §(GCCINCDIR) \} 
               &\\\hline

tiny           & -nostdinc -DUSE_DIETLIBC=y -I\{ §(L4DIR)/include/dietlibc
                 §(DROPS_STDDIR)/include/dietlibc §(GCCINCDIR) \} 
               &\\\hline

sigma0         & -nostdinc -DUSE_DIETLIBC=y -I\{ §(L4DIR)/include/dietlibc
                 §(DROPS_STDDIR)/include/dietlibc §(GCCINCDIR) \} 
               &\\\hline

libc           & -nostdinc -I\{ §(GCCINCDIR) §(L4DIR)/include/dietlibc
                 §(DROPS_STDDIR)/include/dietlibc \}
               &\\\hline

host           & - 
               &\\\hline

l4linux        & -I§(GCCINCDIR)
               &\\\hline

\end{ptabtwo}
\caption{Directories for include file search depending on the mode for
\emph{dietlibc}.}
\label{tab:mode-incdirs-diet}
\end{table}

\begin{table}[htp]
\begin{ptabtwo}
\hline
\bf Mode        & \bf «§LIBCINCDIR» &\\\hline\hline

l4env          & -nostdinc -I\{ §(L4DIR)/include/\{x86, arm, amd64\}/uclibc
		 §(L4DIR)/include/uclibc §(L4DIR)/include/uclibc++
		 §(DROPS_STDDIR)/include/\{x86, arm, amd64\}/uclibc
		 §(DROPS_STDDIR)/include/uclibc
		 §(DROPS_STDDIR)/include/uclibc++ §(GCCINCDIR) \}
               &\\\hline

l4env\_minimal & -nostdinc -I\{ §(L4DIR)/include/\{x86, arm, amd64\}/uclibc
		 §(L4DIR)/include/uclibc §(L4DIR)/include/uclibc++
		 §(DROPS_STDDIR)/include/\{x86, arm, amd64\}/uclibc
		 §(DROPS_STDDIR)/include/uclibc
		 §(DROPS_STDDIR)/include/uclibc++ §(GCCINCDIR) \}
               &\\\hline

l4env\_base    & -nostdinc -I\{ §(L4DIR)/include/\{x86, arm, amd64\}/uclibc
		 §(L4DIR)/include/uclibc §(L4DIR)/include/uclibc++
		 §(DROPS_STDDIR)/include/\{x86, arm, amd64\}/uclibc
		 §(DROPS_STDDIR)/include/uclibc
		 §(DROPS_STDDIR)/include/uclibc++ §(GCCINCDIR) \}
               &\\\hline

tiny           & -nostdinc -I\{ §(L4DIR)/include/\{x86, arm, amd64\}/uclibc
		 §(L4DIR)/include/uclibc §(L4DIR)/include/uclibc++
		 §(DROPS_STDDIR)/include/\{x86, arm, amd64\}/uclibc
		 §(DROPS_STDDIR)/include/uclibc
		 §(DROPS_STDDIR)/include/uclibc++ §(GCCINCDIR) \}
               &\\\hline

sigma0         & -nostdinc -I\{ §(L4DIR)/include/\{x86, arm, amd64\}/uclibc
		 §(L4DIR)/include/uclibc §(L4DIR)/include/uclibc++
		 §(DROPS_STDDIR)/include/\{x86, arm, amd64\}/uclibc
		 §(DROPS_STDDIR)/include/uclibc
		 §(DROPS_STDDIR)/include/uclibc++ §(GCCINCDIR) \}
               &\\\hline

libc           & -nostdinc -I\{ §(GCCINCDIR) §(L4DIR)/include/dietlibc
                 §(DROPS_STDDIR)/include/dietlibc \}
               &\\\hline

host           & - 
               &\\\hline

l4linux        & -I§(GCCINCDIR)
               &\\\hline

\end{ptabtwo}
\caption{Directories for include file search depending on the mode for
\emph{uclibc}.}
\label{tab:mode-incdirs-uc}
\end{table}

\begin{table}[htp]
\index{§(MODE)}\index{§(LIBCLIBDIR)}%
\begin{ptabtwo}
\hline
\bf Mode        & \bf «§LIBCLIBDIR» &\\\hline\hline

l4env          & - 
               &\\\hline

l4env\_minimal & -
               &\\\hline

l4env\_base    & -
               &\\\hline

tiny           & -
               &\\\hline

sigma0         & -
               &\\\hline

libc           & -
               &\\\hline

host           & -
               &\\\hline

l4linux        & -
               &\\\hline

\end{ptabtwo}
\caption{Directories for library path search depending on the mode.}
\label{tab:mode-libdirs}
\end{table}

\begin{table}[htp]
\index{§(LIBCLIBS)}
\begin{ptabtwo}
\hline
\bf Mode        & \bf «§LIBCLIBS» &\\\hline\hline

l4env          & -nostdlib §(GCCLDNOSTDLIB) §(DIETLIBC_IMPLEMENTATION) 
		 -ldietlibc_support §(MALLOC_BACKEND) -lc_be_mmap
		 -lc_be_mmap_util -lc_be_l4env_start_stop
		 -lc_be_minimal_log_io -ldiet_be_simple_sleep -ll4env
		 -llogserver_capsule -ll4rm -ldm_generic -ldm_mem  -lthread
		 -lgeneric_ts §(DIETLIBC_IMPLEMENTATION) §(GCCLIB)
		 §(DIETLIBC_IMPLEMENTATION) -ll4sys 
	       &\\\hline

l4env\_minimal & -nostdlib §(GCCLDNOSTDLIB) §(MALLOC_BACKEND)
		 §(DIETLIBC_IMPLEMENTATION) -lc_be_l4env_start_stop
		 -lgeneric_ts -lc_be_minimal_log_io -lc_be_mmap_util
		 §(MALLOC_BACKEND) -lc_be_mmap -lc_be_mmap_util -ll4rm
		 -ldm_mem -ldm_generic -lthread -lsemaphore -ll4env
		 -ll4env_err -lslab -llogserver_capsule -ll4rm -lthread
		 -ldm_generic -lnames -ll4util_root -ll4util -lsigma0
		 §(DIETLIBC_IMPLEMENTATION) §(GCCLIB)
		 §(DIETLIBC_IMPLEMENTATION) -lc_be_l4env_start_stop -ll4sys
               &\\\hline

l4env\_base    & -nostdlib §(GCCLDNOSTDLIB) -u printf -lc_be_io.o
		 §(MALLOC_BACKEND) -lc_be_time -lrtc -ll4rm -ldm_mem
		 -ldm_generic -lthread -lsemaphore -ll4env -ll4env_err -lslab
		 -llogserver_capsule -ll4rm -lthread -ldm_generic -lnames
		 -ll4util_root -ll4util -lsigma0 §(DIETLIBC_IMPLEMENTATION)
		 §(GCCLIB) §(DIETLIBC_IMPLEMENTATION) §(MALLOC_BACKEND) -ll4rm
		 -ldm_mem -ldm_generic -lc_be_time -lc_be_mmap
		 -lc_be_mmap_util -lc_be_l4env_start_stop -lgeneric_ts
		 -lc_be_syslog -lc_be_file-table -ldiet_be_simple_sleep
		 -ll4vfs_common_io -ll4vfs_basic_io -ll4vfs_connection
		 -ll4vfs_basic_name_server -ll4vfs_name_server
		 -ll4vfs_name_space_provider -ll4vfs_extendable
               &\\\hline

tiny           & -nostdlib §(GCCLDNOSTDLIB) -ldiet_c -ldietlibc_support
                 -ldiet_be_minimal_io -ldiet_be_l4_start_stop
		 -ldiet_be_sigma0_mem -ldiet_c -ll4util -lsigma0 -ldiet_c
		 §(GCCLIB) -ldiet_c -ll4sys 
               &\\\hline

sigma0         & -nostdlib §(GCCLDNOSTDLIB) -ldiet_c -ldietlibc_support
                 -ldiet_be_minimal_io -ldiet_be_l4_start_stop
		 -ldiet_be_sigma0_mem -ldiet_c -llogserver -lnames -lsigma0
		 -ll4util_root -ll4util §(ROOTLIB) -ldiet_c §(GCCLIB) -ldiet_c
		 -ll4sys
               &\\\hline

libc           & -nostdlib §(GCCLDNOSTDLIB) -ldiet_c §(LIBCBACKEND_LIB)
                 §(GCCLIB) -ldiet_c
               &\\\hline

host           & -
               &\\\hline

l4linux        & -ldm_generic -ldm_mem -lnames  -ll4util_root -ll4util
		 §(ROOTLIB) -lloaderif -ll4env -ll4env_err -lslab -ll4sys
	       &\\\hline

\end{ptabtwo}
\caption{Standard libc-libraries of \emph{dietlibc} depending on the mode.}
\label{tab:mode-clibs-diet}
\end{table}

\begin{table}[htp]
\begin{ptabtwo}
\hline
\bf Mode        & \bf «§LIBCLIBS» &\\\hline\hline

l4env          & -nostdlib §(GCCLDNOSTDLIB) §(UCLIBC_IMPLEMENTATION)
		 -luclibc_support §(MALLOC_BACKEND) -lc_be_mmap
		 -lc_be_mmap_util -lc_be_l4env_start_stop
		 -lc_be_minimal_log_io -luc_be_simple_sleep -ll4env
		 -llogserver_capsule -ll4rm -ldm_generic -ldm_mem -lthread
		 -lgeneric_ts §(UCLIBC_IMPLEMENTATION) §(GCCLIB)
		 §(UCLIBC_IMPLEMENTATION) -ll4sys
	       &\\\hline

l4env\_minimal & -nostdlib §(GCCLDNOSTDLIB) §(MALLOC_BACKEND)
		 §(UCLIBC_IMPLEMENTATION) -lc_be_l4env_start_stop -lgeneric_ts
		 -lc_be_minimal_log_io -lc_be_mmap_util §(MALLOC_BACKEND)
		 -lc_be_mmap -lc_be_mmap_util -ll4rm -ldm_mem -ldm_generic
		 -lthread -lsemaphore -ll4env -ll4env_err -lslab
		 -llogserver_capsule -ll4rm -lthread  -ldm_generic -lnames
		 -ll4util_root -ll4util -lsigma0 §(UCLIBC_IMPLEMENTATION)
		 §(GCCLIB) §(UCLIBC_IMPLEMENTATION) -lc_be_l4env_start_stop
		 -luclibc_support -ll4sys
               &\\\hline

l4env\_base    & -nostdlib §(GCCLDNOSTDLIB) -u printf -lc_be_io.o
		 §(MALLOC_BACKEND) -lc_be_time -lrtc -ll4rm -ldm_mem
		 -ldm_generic -lthread -lsemaphore -ll4env -ll4env_err -lslab
		 -llogserver_capsule -ll4rm -lthread -ldm_generic -lnames
		 -ll4util_root -ll4util -lsigma0 §(UCLIBC_IMPLEMENTATION)
		 §(GCCLIB) §(UCLIBC_IMPLEMENTATION) §(MALLOC_BACKEND) -ll4rm
		 -ldm_mem -ldm_generic -lc_be_time -lc_be_mmap
		 -lc_be_mmap_util -lc_be_l4env_start_stop -lgeneric_ts
		 -lc_be_syslog -lc_be_file-table -luc_be_simple_sleep
		 -ll4vfs_common_io -ll4vfs_basic_io -ll4vfs_connection
		 -ll4vfs_basic_name_server -ll4vfs_name_server
		 -ll4vfs_name_space_provider -ll4vfs_extendable -ll4sys
               &\\\hline

tiny           & -nostdlib §(GCCLDNOSTDLIB) -luc_c -luc_be_minimal_io
		 -luc_be_l4_start_stop -luc_be_sigma0_mem -luc_c
		 -luclibc_support -ll4util -lsigma0 -luc_c §(GCCLIB) -luc_c
		 -ll4sys
               &\\\hline

sigma0         & -nostdlib §(GCCLDNOSTDLIB) -luc_c -luc_be_minimal_io
		 -luc_be_l4_start_stop -luc_be_sigma0_mem -luc_c
		 -luclibc_support -llogserver -lnames -lsigma0 -ll4util_root
		 -ll4util §(ROOTLIB) -luc_c §(GCCLIB) -luc_c -ll4sys
               &\\\hline

libc           & -nostdlib §(GCCLDNOSTDLIB) -ldiet_c §(LIBCBACKEND_LIB)
                 §(GCCLIB) -ldiet_c
               &\\\hline

host           & -
               &\\\hline

l4linux        & -ldm_generic -ldm_mem -lnames  -ll4util_root -ll4util
		 §(ROOTLIB) -lloaderif -ll4env -ll4env_err -lslab -ll4sys
	       &\\\hline

\end{ptabtwo}
\caption{Standard libc-libraries of \emph{uclibc} depending on the mode.}
\label{tab:mode-clibs-uc}
\end{table}


\begin{table}[htp]
\index{§(L4LIBS)}
\begin{ptabtwo}
\hline
\bf Mode        & \bf «§L4LIBS»
&\\\hline\hline

l4env          & -static -lgeneric_ts -ll4env -ll4rm -ldm_generic -ldm_mem
                 -lthread -lsemaphore -llogserver_capsule -lnames
		 -ll4util_root -ll4util -lsigma0 §(ROOTLIB) -ll4env
		 -ll4env_err -ll4rm -ldm_generic -ldm_mem -lthread -lslab
		 -ll4sys
               &\\\hline

l4env\_minimal & -static -ll4rm -ldm_mem -ldm_generic -lthread -lsemaphore
                 -ll4env -ll4env_err -lslab -llogserver_capsule -ll4rm
		 -lthread -ldm_generic -lnames -ll4util_root -ll4util -lsigma0 
		 §(ROOTLIB) -ll4sys
               &\\\hline

l4env\_base    & -static -ll4rm -ldm_mem -ldm_generic -lthread -lsemaphore
                 -ll4env -ll4env_err -lslab -llogserver_capsule -ll4rm
		 -lthread -ldm_generic -lnames -ll4util_root -ll4util -lsigma0
		 §(ROOTLIB) -ll4sys
               &\\\hline

tiny           & -static -lmain -ll4util -ll4sys
               &\\\hline

sigma0         & -static -lmain -lnames -llogserver -ll4util_root -ll4util
                 -ll4sys
               &\\\hline

libc           & -
               &\\\hline

host           & -
               &\\\hline

l4linux        & -
               &\\\hline

\end{ptabtwo}
\caption{L4 libraries to be linked depending on the mode.}
\label{tab:mode-l4libs}
\end{table}

\begin{table}[htp]
\index{§(LIBCLIBS)}\index{§(CRT0)}\index{§(CRTN)}\index{§(LDSCRIPT)}
\begin{ptabthree}{.41}{.42}
\hline
\bf Mode        & \bf «§CRT0» & \bf «§LDSCRIPT» 
&\\\hline\hline

l4env          & crt0.o
               & main_stat.ld
               &\\\hline

l4env\_minimal & crt0.o
               & main_stat.ld
               &\\\hline

l4env\_base    & crt0.o
               & main_stat.ld
               &\\\hline

tiny           & crt0.o
               & main_stat.ld
               &\\\hline

sigma0         & crt0.o
               & main_stat.ld
               &\\\hline

libc           & crt0.o
               & main_stat.ld
               &\\\hline

host           & -
               & -
               &\\\hline

l4linux        & -
               & -
               &\\\hline

\end{ptabthree}
\caption{Startup code (CRT0) and linker scripts depending on the mode.}
\label{tab:mode-crt0ldscript}
\end{table}

\paragraph*{Examples}

Examples for the various modes can be found within the following
packages:

\begin{description}

\item[sigma0] \name{names}: library
\item[host] \name{names}: lister example
\item[l4env] \name{con}: library and server

\end{description}



\subsection{Defining new architectures and modes}
\label{sec:modes-defining-own}
\enlargethispage*{3ex}

Defining additional architecture/mode pairs for a specific
architecture is done by setting appropriate Make-variables. To define
mode «mode» for architecture «arch», set «BID_SUPPORTED_arch_mode» to
``y'' and define the variables «LIBCINCDIR_arch_mode»,
«LIBCLIBDIR_arch_mode», «LIBCLIBS_arch_mode», «L4LIBS_arch_mode»,
«CRT0_arch_mode», «CRTN_arch_mode» and «LDSCRIPT_arch_mode».

Also, you can set
«CARCHFLAGS_<arch>_<cpu>»\index{§(CARCHFLAGS_arch_cpu)} to specify
cpu-specific compiler options, e.g. «CARCHFLAGS_x86_p3=-march=p3» if
-march=p3 is the compiler option to generate p3-optimized code.

\vfill\pagebreak
\section{Relocated binaries and the STATIC file}
\label{sec:reloc}
\label{sec:reloc-STATIC}
\index{relocation}

This is the classical approach of building an executable binary: Link
it starting at a specific address. However, we offer some magic here
too. To determine the final start-address of your binary, «prog.mk»
uses a kind of database. It determines the start-addresses of each
binary using a central place, the file
«§(L4DIR)/pkg/STATIC»\index{STATIC file}\index{relocation!STATIC
file}. Each line of this file contains the start-address and the name
of a binary. «prog.mk» looks up the name of the binary in this file,
and if it is found, the corresponding start-address is used. If the
name of the binary is not found in STATIC, the start-address specified
in «DEFAULT_RELOC++» is used.


\pagebreak\section{The Role-Files}
\subsubsection*{Abbreviations}

Within the next sections, the following abbreviations are used in the
description of role-file parameters:

%\framebox[\columnwidth]{}

\begin{descriptiontable}{XXX++}
  XXX+  & The parameter «XXX» can be specified in multiple forms.
          To set the parameter for all targets (defined in the parameter
          «§(TARGET)» then), just specify \textbf{«XXX»}. To set the
          parameter for a special target «target» out of
          «§(TARGET)», specify \textbf{«XXX_target»}. \\

  XXX++ & The parameter «XXX» can be specified in multiple forms.
          To set the parameter for all targets (defined in the
          parameter «§(TARGET)» then) and all systems
          (defined in the parameter «§(SYSTEM)» then), just specify
          \textbf{«XXX»}. To set the parameter for a special target
          «target» for all given systems, specify
          \textbf{«XXX_target»}. To set the parameter for a special
          system «sys» for all given targets, specify
          \textbf{«XXX_sys»}. To set the parameter for a special target
          «target» for a special system «sys»,
          specify \textbf{«XXX_target_sys»}. 
\end{descriptiontable}


\subsection{Common Role-File Targets and Parameters}

\subsubsection{Make-Targets}

All role-files support the following phony targets, which can be build
using «make <target>».

\begin{description}
\item [config::]        \index{config:: make target}
                        Runs the menu-driven configuration utility.
                        See Section \ref{sec:config} for details.
\item [txtconfig::]     \index{txtconfig:: make target}
                        Runs the configuration utility. For
                        directories, a recursive invocation is done.
                        See Section \ref{sec:config} for details.
\item [oldconfig::]     \index{oldconfig:: make target}
                        (Re)creates a configuration header file based
                        on a prior configuration or defaults. For
                        directories, a recursive invocation is done.
                        See Section \ref{sec:config} for details.
\item [all:]            \index{all:: make target}
                        The default target. It depends on the role,
                        what exactly is done.
\item [install::]       \index{install:: make target}
                        Installs the generated files into the
                        installation-tree «§(DROPS_STDDIR)».
\item [clean::]         \index{clean:: make target}
                        Deletes all intermediate files generated
                        during compilation. This does \emph{not}
                        delete the generated targets such as binaries
                        or libs.
\item [cleanall::]      \index{cleanall:: make target}
                        Deletes all generated and backup files. Invokes
                        \textbf{clean::}.
\item [help::]          \index{help:: make target}
                        Displays a short overview of the make-targets
                        available with this role.
\item [FORCE:]          \index{help:: make target}
                        This target is not intended to build, but to
                        depend on. If something depends on FORCE, it
                        is built.
\end{description}


\subsubsection{Required Parameters}

All role-files require the following variables to be set:

\begin{parameterlist}{PKGDIR}
    L4DIR       & \index{§(L4DIR)}
                  The base directory of the L4 tree. \#
    PKGDIR      & \index{§(PKGDIR)}
                  The base directory of the package. \#
\end{parameterlist}


\subsubsection{Optional Parameters}
\label{sec:common-targets-opt}

Most role files use the following variables:

\begin{parameterlist}{DEPEND_VERBOSE}
    SUBDIRS        & \index{§(SUBDIRS)}%
                     used by «prog.mk», «lib.mk», «idl.mk», «doc.mk»
                     \\\cline{2-2} & 
                     A list of subdirectories that will be treated
                     specially: For each element of the list, a target
                     will be created. If this target it called, the
                     \textbf{all}-rule in the according directory will be
                     called. Furthermore, \textbf{scrub}, \textbf{clean} and
                     \textbf{cleanall} are made recursively for the
                     specified directories. Default: unset. \#

    DEPEND_VERBOSE & \index{§(DEPEND_VERBOSE)}%
                     used by all roles\\\cline{2-2} & 
                     If set to '«@»', no commands for
                     dependency-generation will be shown. Default: unset.\#

    DROPS_STDDIR   & \index{§(DROPS_STDDIR)}%
                     used by all roles\\\cline{2-2} & 
                     The base-directory of the install-tree. Default: 
                     «/home/drops» \#

    HAVE_LDSO      & \index{§(HAVE_LDSO)}%
                     used by «prog.mk», «lib.mk», «idl.mk»
                     \\\cline{2-2} & 
                     If enabled (nonempty), dependency generation uses
                     descent algorithms (see Section \ref{sec:dependencies}
                     for details). Only disable this option if your host
                     system does not provide ld.so, set this option empty
                     then.  Default: y (enabled). \#

    SHOWMESSAGES   & \index{§(SHOWMESSAGES)}%
                     used by all roles\\\cline{2-2} & 
                     If set to "true" or "y", a short textual description for
                     every compilation step is printed. Default:
                     true. \#

    VERBOSE        & \index{§(VERBOSE)}%
                     used by all roles\\\cline{2-2} & 
                     If set to '«@»', the commands invoked by make
                     will not be shown.
                     Default: unset.\#

\end{parameterlist}


\subsubsection{Provided Variables}

The following variables are \emph{provided} by the role files.

\begin{parameterlist}{PKGNAME}
    PKGNAME        & \index{§(PKGNAME)}
                     The last part of the directory name specified
                     in «§(PKGDIR)». \#
\end{parameterlist}


\vfill\pagebreak
\subsection{Role-File prog.mk}
\label{sec:prog.mk}

\subsubsection{Purpose}

The purpose of the prog role is to build executable binaries for
different systems. The executable binaries are the targets.

\subsubsection{Make-Targets}

\begin{description}
\item [all:]    Phony target. Build all targets and install them into
                the local install-tree then. The local install-tree is
                «§(L4DIR)/bin». To install, «strip --strip-unneeded» is
                used.

\item [relink:] \index{relink: make target}
                Phony target. Relink and reinstall the targets,
                in the case your dependencies are somehow wrong.

\end{description}

\subsubsection{Provided Variables}

The following variables are provided by the prog.mk role-file:

\begin{parameterlist}{GCCINCDIR}
    GCCINCDIR           & The path where the gcc-specific
                          include-files, such as «stdarg.h». Never
                          (really, NEVER) try to include a «stdarg.h»
                          from a C library!). \#

    GCCLIB              & The name of the compiler's companion library
                          (libgcc). \#
\end{parameterlist}



\subsubsection{Required Parameters}

\begin{parameterlist}{TARGET_<system>}
    \bf{}TARGET           & The list of the targets. \#

    \multicolumn{2}{|l|}{\rm{}Or:}\#

    TARGET_<system>       & The list of the targets for a special
                          system. Specify the system(s) in «SYSTEMS». \#
\end{parameterlist}


\subsubsection{Optional Parameters}

\begin{parameterlist}{INSTALLFILE_BIN_LOCAL}
    ASFLAGS++         & \index{§(ASFLAGS)}%
                        standard Makefile variable, used additionally
                        for compiling assembler files.
                        Default: empty. \#

    BID_STRIP_PROGS   & \index{§(BID_STRIP_PROGS)}%
                        If set to ``y'', strip binaries on
                        installation into local or global
                        bin-directories using «§(STRIP)
                        --strip-unneeded».
                        Default: empty.\#

    BUILD_PROFILE++   & \index{§(BUILD_PROFILE)}%
                        If nonempty, additional profile-versions of
                        the targets are built. Therefore, each
                        generated .o-file has an according .pr.o-file,
                        which is compiled using the options
                        «-pg -DPROFILE». Each target is accompanied
                        by an additional file with the suffix .pr.
                        These additional files contain the profile
                        code and are linked against profile libraries.
                        See Section \ref{sec:lib.mk} on how to build
                        profile libraries. Default: empty
                        \#

    CLIENTIDL++       & \index{§(CLIENTIDL)}%
			IDL client source files. The .c and .cc-files compiled
			from the given IDLs are added to SRC_C++ and SRC_CC++
			respectively.
                        Default: unset. \#

    CFLAGS++          & \index{§(CFLAGS)}%
                        standard Makefile variable, used additionally
                        for the compiler.
                        Default: adds §(OPTS) §(WARNINGS). \#

    CPPFLAGS++        & \index{§(CPPFLAGS)}%
                        standard Makefile variables, used additionally
                        for preprocessor.
                        Default: adds §(DEFINES) -I\{§(PRIVATE_INCDIR)
                        §(IDL_PATH)
                        §(GCCINCDIR) §(L4INCDIR)\} §(LIBCINCDIR).
                        §(IDL_PATH) is added if either §(CLIENTIDL) or
                        §(SERVERIDL) are set.
                        With §(MODE)=host, §(L4INCDIR) is not added.
                        \#

    CRT0              & \index{§(CRT0)}%
                        CRT0 object to link as fist object to the
                        binary. Default depends on the selected mode. 
                        \#

    CRTN              & \index{§(CRTN)}%
                        CRTN object to link as last object to the
                        binary. Default depends on the selected mode. 
                        \#

    CXXFLAGS++        & \index{§(CXXFLAGS)}%
                        standard Makefile variable, used additionally
                        for compiling C++ files.
                        Default: adds §(OPTS) §(WARNINGS). \#

    DEBUG             & \index{§(DEBUG)}%
                        If set, adds «-DDEBUG» to §(DEFINES).
                        See there for details.\#

    \bf{}DEFAULT_RELOC++
                      & \index{§(DEFAULT_RELOC)}%
                        The default link-addresses for the
                        targets. Depending on the system, a
                        relocation address needs to be specified. This
                        address is used, if the default-reloc
                        mechanism (see \ref{sec:reloc}) does
                        not deliver an address. Default: unset. \#

    DEFINES++         & \index{§(DEFINES)}%
                        Container for additional defines for the
                        preprocessor. Default: Adds §(ARCH), §(CPU)
                        and §(L4API) as defines. See Section
                        \ref{sec:systems-compile} for details. 
                        If §(DEBUG) is set, «-DDEBUG» is added.
                        \#

    IDL_PATH++        & \index{§(IDL_PATH)}%
                        The path to IDL-files. This path is used to
                        find the client and server idl-files. Default:
                        «§(PKG_DIR)/idl/OBJ-§(SYSTEM)». \#

    IDL_PKGDIR        & \index{§(IDL_PKGDIR)}%
                        A list of package directories where IDL files are used
			from. This will eventually supercede «§(IDL_PATH)».
			Default: «§(PKGDIR)». \#

    IDL_TYPE+         & \index{§(IDL_TYPE)}%
                        The type of the IDL-files. This type is used
                        to determine the compiler to use. See Section
                        \ref{sec:role-idl} for details.
                        Default: «dice».
                        
                        Note: The '+' refers to the different
                        IDL-files, not to the values of
                        «§(TARGET)».  \#

    INSTALL_TARGET+   & \index{§(INSTALL_TARGET)}%
                        The list of the targets that will be installed
                        automatically or on «make install». Default:
                        The targets and the targets specific to the
                        current system. Also see the «NOTARGETSTOINSTALL»
                        parameter.\#

    INSTALLDIR_BIN    & \index{§(INSTALLDIR_BIN)}%
                        The directory in the global install tree to
                        install a binary to.
                        Default: «§(DROPS_STDDIR)/bin» \#

    INSTALLDIR_BIN_LOCAL &
                        \index{§(INSTALLDIR_BIN_LOCAL)}%
                        The directory in the local install tree to
                        install a binary to.
                        Default: «§(L4DIR)/bin» \#

    INSTALLFILE_BIN   & \index{§(INSTALLFILE_BIN)}%
                        The command to install a binary to the global
                        install  tree.

                        Default depends on «§(BID_STRIP_PROGS)». \#

    INSTALLFILE_BIN_LOCAL &
                        \index{§(INSTALLFILE_BIN_LOCAL)}%
                        The command to install a binary to the local
                        install  tree.

                        Default depends on «§(BID_STRIP_PROGS)». \#

    KEEP_ON_CLEAN       & \index{§(KEEP_ON_CLEAN)}%
                        A list of files that should not be removed on
                        a ``make clean''.

                        Default: empty. \#

    L4INCDIR++          & \index{§(L4INCDIR)}%
                        System-dependent list of include directories.
                        Default:

                        «§(L4DIR)/include/§(ARCH)/§(L4API)
                        
                        §(DROPS_STDDIR)/include/§(ARCH)/§(L4API)

                        §(L4DIR)/include/§(ARCH)

                        §(DROPS_STDDIR)/include/§(ARCH)

                        §(L4DIR)/include

                        §(DROPS_STDDIR)/include» \#

    L4LIBDIR++          & \index{§(L4LIBDIR)}%
                        System-dependent list of library directories.
                        Default:

                        «§(L4DIR)/lib/§(ARCH)_§(CPU)/§(L4API)

                        §(DROPS_STDDIR)/lib/§(ARCH)_§(CPU)/§(L4API)

                        §(L4DIR)/lib/§(ARCH)_§(CPU)

                        §(DROPS_STDDIR)/lib/§(ARCH)_§(CPU)

                        §(L4DIR)/lib

                        §(DROPS_STDDIR)/lib» \#

    L4LIBS            & \index{§(L4LIBS)}%
                        Libraries and flags for the binary. Depends
                        on the selected mode. \#

    LDFLAGS++         & \index{§(LDFLAGS)}%
                        standard Makefile variables, used as
                        additional flags for the linker. Default for
                        mode host: -L\{§(PRIVATE_LIBDIR)
                        §(LIBCLIBDIR)\} §(LDSCRIPT) §(LIBS) §(L4LIBS)
                        §(LIBCLIBS).

                        Default otherwise: -L\{§(PRIVATE_LIBDIR)
                        §(L4LIBDIR) §(LIBCLIBDIR)\} §(LDSCRIPT)
                        §(LIBS) §(L4LIBS) §(LIBCLIBS).\#

    LDSCRIPT++        & \index{§(LDSCRIPT)}%
                        The name of the standard linker script used to
                        link the binary. Default depends on the mode. \#

    LIBCINCDIR        & \index{§(LIBCINCDIR)}%
                        Include path and flags to the libc includes.
                        Default: Determined by the mode, points to
                        dietlibc or uClibc normally. \#

    LIBCLIBDIR        & \index{§(LIBCLIBDIR)}%
                        Library path and flags to libc.
                        Default: Determined by the mode, points to
                        dietlibc or uClibc normally. \#

    LIBCLIBS          & \index{§(LIBCLIBS)}%
                        Libraries and flags for libc.
                        Default: Determined by the mode, points to
                        dietlibc or uClibc with support libraries
                        normally. \#

    \bf{}LIBS++       & \index{§(LIBS)}%
                        libraries and objects to be linked to the targets.
                        Contains additional PATHS (with -L) and libs
                        (with -l). Default: unset. \#

    \bf{}MODE++       & \index{§(MODE)}%
                        Specify, which target system a target has to
                        be built for (see Section
                        \ref{sec:systems-modes}). Default: l4env \#

    NOTARGETSTOINSTALL & \index{§(NOTARGETSTOINSTALL)}%
                        If nonempty, the binaries will not be installed,
                        neither in the local §(L4DIR)/bin nor in the
                        global §(DROPS_STDDIR)/bin. Default: empty\#
                        
    OPTS              & \index{§(OPTS)}%
                        Optimization switches for the compiler.
                        Default: «-g -O2» plus arch-dependent switches \#

    \bf{}PRIVATE_INCDIR++
                      & \index{§(PRIVATE_INCDIR)}%
                        Additional list of include-directories. Will
                        be prefixed with -I.
                        Default: unset \#

    PRIVATE_LIBDIR++  & \index{§(PRIVATE_LIBDIR)}%
                        Additional list of library-directories. Will
                        be prefixed with -L.
                        Default: unset \#

    SERVERIDL++       & \index{§(SERVERIDL)}%
                        IDL server source files. The .c and .cc-files compiled
                        from the given IDLs are added to SRC_C++ and SRC_CC++
			respectively.
                        Default: unset. \#

    \bf{}SRC_\{C,CC,S\}++ 
                      & \index{§(SRC_C)}\index{§(SRC_CC)}\index{§(SRC_S)}%
                        The list of source \{.c, .cc, .S\}-files
                        which have to be compiled and linked to the targets.
                        Default: unset. \#

    SYSTEMS           & \index{§(SYSTEMS)}%
                        The systems the targets have to be build
                        for. If multiple systems are given, each
                        system is build into a separate
                        directory. Default: x86-l4v2. \#

    WARNINGS++        & \index{§(WARNINGS)}%
                        Warning switches for the compiler. Default:
                        «-Wall -Wstrict-prototypes -Wmissing-prototypes 
                         -Wmissing-declarations» \#


\end{parameterlist}


\subsubsection{Example}
\begin{verbatim}
PKGDIR = ..
L4DIR ?= §(PKGDIR)/../..

TARGET = ping
SRC_C  = ping.c

include §(L4DIR)/mk/prog.mk
\end{verbatim}

\subsubsection{C++ programs}

If you do not need exception support, you can use the l4env mode,
which comes with a much smaller libc. You have to define some
callbacks then. Please see the exec server as an example. You should specify
«CXXFLAGS» = -fno-exceptions -fno-rtti.

\begin{implemented}
\item [«BUILD_PROFILE»] To make it work, additional libraries
  (libl4sys.pr) must be linked, which is not the case now. It is not
  clear, if all l4-libraries should be exchanged by profiling variants
  or not.
\item [«MODE»] is currently interpreted as MODE, not as MODE++.
\end{implemented}



\vfill\pagebreak
\subsection{Role-File lib.mk}
\label{sec:lib.mk}

\subsubsection{Purpose}

The purpose of the lib role is to build static and shared libraries
for different systems. The libraries are the targets.

To build shared libraries, simply end the «TARGET» library name on .s.so.
The additional ``.s'' later allows to explicitly specify linking against a
shared library by specifying the different library base name to the linker.
The use of «BUILD_SHARED» is deprecated.

To build libraries that can be used to build shared libraries later,
set the «BUILD_PIC» option to nonempty. The resulting libraries
can be linked into shared libraries then. They end on .p.a.

Both shared and pic-libraries use objects compiled with the PIC-option
enabled. The corresponding object-files end on .s.o after compilation.

To build libraries with profiling support, set the
«BUILD_PROFILE» to nonempty. Each generated .o-file will have an
accompanying .pr.o-file, which is compiled using the options 
«-pg -DPROFILE». Each target-lib is accompanied by an additional
lib with the suffix .pr.a. These additional libs contain the profile
code. See Section \ref{sec:prog.mk} on how to build profile
executables.

If all «BUILD_SHARED», «BUILD_PIC» and «BUILD_PROFILE»
options are set, you end with not less than six libraries, and 4
object-files per source-file. Suffixes: .o, .pr.o, .s.o, .pr.s.o, .a,
.pr.a, .p.a, .s.so, .pr.p.a, .pr.s.so.

Note, that prior to building libraries, the library files are
deleted. This prevents old (obsolete) object-files to be within the
libraries.


\subsubsection{Make-Targets}

\begin{description}
\item [all:]    Phony target. Build all libraries and install them
                into the local install-tree then. The local
                install-tree is «§(L4DIR)/lib». To install,
                «ln -s» is used.

\item [relink:] \index{relink: make target}
                Phony target. Relink and reinstall the libraries,
                in the case your dependencies are somehow wrong.

\item [XXX_p.a:] This target is a library containing
                position-independent code only. The according
                object-files end on _p.o and are compiled using
                appropriate compiler-calls analogously to the other
                .o-Files.

\item [XXX_s.a:] This target is a shared library. This difference in
                filenames allows to explicitly distinguish between linking of
                static versus shared libraries.
\end{description}

\subsubsection{Provided Variables}

The following variables are provided by the prog.mk role-file:

\begin{parameterlist}{GCCINCDIR}
    GCCINCDIR           & The path where the gcc-specific
                          include-files, such as «stdarg.h». Never
                          (really, NEVER) try to include a «stdarg.h»
                          from a C library!). \#

    GCCLIB              & The name of the compiler's companion library
                          (libgcc). \#
\end{parameterlist}

\subsubsection{Required Parameters}

\begin{parameterlist}{TARGET_<system>}
    \bf{}TARGET         & \index{§(TARGET)}
                          The list of the target libraries.
                          \#

    \multicolumn{2}{|l|}{\rm{}Or:}\#

    TARGET_<system>     & \index{§(TARGET_system)}
                          The list of the target libraries for special
                          system. Specify the system(s) in
                          «SYSTEMS». \#
\end{parameterlist}

\subsubsection{Optional Parameters}
\begin{parameterlist}{INSTALLFILE_LIB_LOCAL}
    ASFLAGS++         & \index{§(ASFLAGS)}%
                        standard Makefile variable, used additionally
                        for compiling assembler files.
                        Default: empty. \#

    BUILD_PROFILE++     & \index{§(BUILD_PROFILE)}
                        If nonempty, additional profile-versions of
                        the target-libs are built. These libraries
                        end on .pr.a. Default: empty
                        \#

    BUILD_SHARED++      & \index{§(BUILD_SHARED)}%
                        If nonempty, the target-libs are built as
                        shared libraries too. These libs end on
                        .s.so. Default: empty \#
                        
    BUILD_PIC++         & \index{§(BUILD_PIC)}%
                        If nonempty, target-libs containing
                        position-independent code (PIC) are built
                        too. These libs end on .p.a. Default: empty
                        \#

    CFLAGS++          & \index{§(CFLAGS)}%
                        standard Makefile variable, used additionally
                        for the compiler.
                        Default: adds §(OPTS) §(WARNINGS). \#

    CLIENTIDL++         & \index{§(CLIENTIDL)}%
                        IDL client source files. The .c and .cc-files compiled
                        from the given IDLs are added to SRC_C++ and SRC_CC++
			respectively.
                        Default: unset. \#

    CPPFLAGS++        & \index{§(CPPFLAGS)}%
                        standard Makefile variables, used additionally
                        for preprocessor.
                        Default: adds §(DEFINES) -I\{§(PRIVATE_INCDIR)
                        §(IDL_PATH)
                        §(GCCINCDIR) §(L4INCDIR)\} §(LIBCINCDIR).
                        §(IDL_PATH) is added if either §(CLIENTIDL) or
                        §(SERVERIDL) are set.
                        With §(MODE)=host, §(L4INCDIR) is not added.
                        \#

    CXXFLAGS++        & \index{§(CXXFLAGS)}%
                        standard Makefile variable, used additionally
                        for compiling C++ files.
                        Default: adds §(OPTS) §(WARNINGS). \#

    DEBUG             & \index{§(DEBUG)}%
                        If set, adds «-DDEBUG» to §(DEFINES).
                        See there for details.\#

    DEFINES++           & \index{§(DEFINES)}%
                        Container for additional defines for the
                        preprocessor. Default: Adds §(ARCH), §(CPU)
                        and §(L4API) as defines. See Section
                        \ref{sec:systems-compile} for details. \#

    IDL_PATH++          & \index{§(IDL_PATH)}%
                        The path to IDL-files. This path is used to
                        find the client and server idl-files. Default:
                        «§(PKG_DIR)/idl/OBJ-§(SYSTEM)». \#

    IDL_PKGDIR        & \index{§(IDL_PKGDIR)}%
                        A list of package directories where IDL files are used
			from. This will eventually supercede «§(IDL_PATH)».
			Default: «§(PKGDIR)». \#

    IDL_TYPE+           & \index{§(IDL_TYPE)}%
                        The type of the IDL-files. This type is used
                        to determine the compiler to use. See Section
                        \ref{sec:role-idl} for details.
                        Default: «dice».
                        
                        Note: The '+' refers to the different
                        IDL-files, not to the values of
                        «§(TARGET)».  \#

    INSTALL_TARGET+   & \index{§(INSTALL_TARGET)}%
                        The list of the targets that will be installed
                        automatically or on «make install». Default:
                        The targets and the targets specific to the
                        current system. Also see the «NOTARGETSTOINSTALL»
                        parameter.\#

    INSTALLFILE_LIB     & \index{§(INSTALLFILE_LIB)}%
                        The command to install a library to the global
                        install  tree.
                        Default: «§(INSTALL) §(1) §(INSTALLDIR_LIB)/» \#

    INSTALLFILE_LIB_LOCAL & \index{§(INSTALLFILE_LIB_LOCAL)}%
                        The command to install a library to the local
                        install  tree.
                        
                        Default: «§(LN) -sf §(call absfilename, §(1))
                        §(INSTALLDIR_LIB_LOCAL)/§(1)» \#

    INSTALLDIR_LIB      & \index{§(INSTALLDIR_LIB)}%
                        The directory in the global install tree to
                        install a library to.
                        Default: «§(DROPS_STDDIR)/lib» \#

    INSTALLDIR_LIB_LOCAL & \index{§(INSTALLDIR_LIB_LOCAL)}%
                        The directory in the local install tree to
                        install a library to.
                        Default: «§(L4DIR)/lib» \#

    CFLAGS++, CXXFLAGS++, ASFLAGS++, CPPFLAGS++
                        & standard Makefile variables, used as
                        additional flags for the compiler,
                        c++-compiler, assembler and preprocessor.
                        Default: unset. \#

    KEEP_ON_CLEAN       & \index{§(KEEP_ON_CLEAN)}%
                        A list of files that should not be removed on
                        a ``make clean''.

                        Default: empty. \#

    L4INCDIR++          & \index{§(L4INCDIR)}%
                        System-dependent list of include directories.
                        Default:

                        «§(L4DIR)/include/§(ARCH)_§(CPU)/§(L4API)
                        
                        §(DROPS_STDDIR)/include/§(ARCH)_§(CPU)/§(L4API)

                        §(L4DIR)/include/§(ARCH)_§(CPU)

                        §(DROPS_STDDIR)/include/§(ARCH)_§(CPU)

                        §(L4DIR)/include

                        §(DROPS_STDDIR)/include» \#

    L4LIBDIR++          & \index{§(L4LIBDIR)}%
                        System-dependent list of library directories.
                        Default:

                        «§(L4DIR)/lib/§(ARCH)_§(CPU)/§(L4API)

                        §(DROPS_STDDIR)/lib/§(ARCH)_§(CPU)/§(L4API)

                        §(L4DIR)/lib/§(ARCH)_§(CPU)

                        §(DROPS_STDDIR)/lib/§(ARCH)_§(CPU)

                        §(L4DIR)/lib

                        §(DROPS_STDDIR)/lib» \#

    \bf{}LIBS++         & \index{§(LIBS)}%
                        objects to be archived to the target libraries.
                        Contains additional PATHS (with -L). Default:
                        unset. \#

    \bf{}MODE++       & \index{§(MODE)}%
                        specify, which target system a target has to
                        be built for (see Section
                        \ref{sec:systems-modes}). Default: l4env \#

    NOTARGETSTOINSTALL & \index{§(NOTARGETSTOINSTALL)}%
                        If nonempty, the libraries will not be installed,
                        neither in the local §(L4DIR)/lib nor in the
                        global §(DROPS_STDDIR)/lib. Default: empty\#
                        
    OPTS              & \index{§(OPTS)}%
                        Optimization switches for the compiler.
                        Default: «-g -O2» plus arch-dependent switches \#

    \bf{}PRIVATE_INCDIR++ 
                        & \index{§(PRIVATE_INCDIR)}%
                        Additional list of include-directories. Will
                        be prefixed with -I.
                        Default: unset \#

    PRIVATE_LIBDIR++    & \index{§(PRIVATE_LIBDIR)}%
                        Additional list of library-directories. Will
                        be prefixed with -L.
                        Default: unset \#

    SERVERIDL++         & \index{§(SERVERIDL)}%
                        IDL server source files. The .c and .cc-files compiled
                        from the given IDLs are added to SRC_C++ and SRC_CC++
			respectively.
                        Default: unset. \#

    \bf{}SRC_\{C,CC,S\}++ 
                        & \index{§(SRC_C)}\index{§(SRC_CC)}\index{§(SRC_S)}%
                        The list of source \{.c, .cc, .S\}-files
                        which have to be compiled and archived into
                        the libraries. Default: unset. \#

    SYSTEMS             & \index{§(SYSTEMS)}%
                        The systems the target libraries have to
                        be build for. If multiple systems are
                        given, each system is built into a
                        separate directory. Default: x86-l4v2. \#

    WARNINGS++          & \index{§(WARNINGS)}%
                        Warning switches for the compiler. Default:
                        «-Wall -Wstrict-prototypes -Wmissing-prototypes 
                         -Wmissing-declarations» \#
\end{parameterlist}

\subsubsection{Example}
\begin{verbatim}
PKGDIR = ..
L4DIR ?= §(PKGDIR)/../..

TARGET = libping.a
SRC_C  = ping.c
include §(L4DIR)/mk/lib.mk
\end{verbatim}

\subsubsection{C++ programs}

If you do not need exception support, you can use the l4env mode,
which comes with a much smaller libc. You have to define some
callbacks then. Please see the exec server as an example.

\vfill\pagebreak
\subsection{Role-File idl.mk}
\label{sec:role-idl}

\subsubsection{Purpose}

The purpose of the IDL role is to translate IDL definition files into
appropriate .c- and .h-files. The .c- and .h-files are the targets. To
compile the generated files, use directories with the prog or lib
role, and import the generated files using IDL-related parameters.
There are no special targets.

\subsubsection{Make-Targets}

\begin{description}
\item [all::]      Phony target. Generate the .c- and .h-files.
\item [install::]  Phony target. Install into «§(DROPS_STDDIR)».
\end{description}

\subsubsection{Required Parameters}

\begin{parameterlist}{\bf{}IDL}
    \bf{}IDL            & The list of the idl definition files. \#
\end{parameterlist}

\subsubsection{Optional Parameters}

\begin{parameterlist}{\bf{}IDL_EXPORT_SKELETON}%
    DEFINES++           & \index{§(DEFINES)}%
                          Container for additional defines for the
                          preprocessor. Default: Adds §(ARCH), §(CPU)
                          and §(L4API) as defines.
                          See Section
                          \ref{sec:systems-compile} for details. \#

    \bf{}IDL_EXPORT_SKELETON
                        & \index{§(IDL_EXPORT_SKELETON)}%
                          Mask of IDL files, whose generated
                          server-include files should be installed
                          into «§(INSTALLDIR_IDL)».
                          Default: empty, nothing to install. \#

    \bf{}IDL_EXPORT_STUB & \index{§(IDL_EXPORT_STUB)}%
                          Mask of IDL files, whose generated
                          client-include files should be installed
                          into «§(INSTALLDIR_IDL)».
                          Default: \%, install the client-headers of
                          all IDL files in §(IDL).\#

    IDL_FLAGS           & \index{§(IDL_FLAGS)}%
                          Additional flags to be passed to the
                          idl-compiler. adds «-P\{ §(DEFINES)
                          -I\{ §(PRIVATE_INCDIR) §(GCCINCDIR)
                          §(L4INCDIR)\} §(LIBCINCDIR) \}».  Also adds
                          flags to use the appropriate back- and
                          front-ends according to «§(L4API)» and
                          «§(IDL_TYPE)». With §(MODE)=host, §(L4INCDIR)
                          is not added. \#

    \bf{}IDL_TYPE+        & \index{§(IDL_TYPE)}%
                          This specifies what kind of idl the idl-files
                          are. This determines the compiler to use.
                          Supported values are
                          \begin{description}
                              \setlength{\parskip}{0pt}
                              \setlength{\itemsep}{0pt}
                              \item[«dice»] The idl(s) is in a modified
                                               DCE-style. Use dice to
                                               compile the idl-file(s).
                              \item[«corba»] The idl(s) is in corba style.
                                                Use dice to compile  the
                                               idl-file(s).
                          \end{description}

                          Default is 'dice'. \#

    INSTALLDIR_IDL & \index{§(INSTALLDIR_IDL)}%
                          The directory to install the created include
                          files to. Default:
                          «§(PKGDIR)/include/ARCH-§(ARCH)/L4API-§(L4API)»
                          \#

    L4INCDIR++          & \index{§(L4INCDIR)}%
                          System-dependent list of include directories.
                          Default:

                          «§(L4DIR)/include/§(ARCH)/§(L4API)
                        
                          §(DROPS_STDDIR)/include/§(ARCH)/§(L4API)

                          §(L4DIR)/include/§(ARCH)

                          §(DROPS_STDDIR)/include/§(ARCH)

                          §(L4DIR)/include

                          §(DROPS_STDDIR)/include» \#

    LIBCINCDIR          & \index{§(LIBCINCDIR)}%
                          Include path and flags to the libc includes.
                          Default: Determined by the mode, points to
                          dietlibc or uClibc normally. \#

    MODE++              & \index{§(MODE)}%
                          specify, which target system a target has to
                          be built for (see Section
                          \ref{sec:systems-modes}). Default: host \#
 
    PRIVATE_INCDIR+     & \index{§(PRIVATE_INCDIR)}%
                          List of directories to prepend to the
                          include-directive of the idl-compiler.
                          \#

    SYSTEMS             & \index{§(SYSTEMS)}%
                          The systems the .c and .h files have to be build
                          for. Each system is build into a separate
                          directory. Default: x86-l4v2. \#

\end{parameterlist}


\subsubsection{Example}
\begin{verbatim}
PKGDIR = ..
L4DIR ?= §(PKGDIR)/../..

IDL = ping.idl

include §(L4DIR)/mk/idl.mk
\end{verbatim}

\subsubsection{C++ programs}

If the «IDL_FLAGS» parameter specifies the C++ languag mapping using -BmCPP,
then C++ files are generated. They end on .cc and .hh and are added to SRC_CC
variables of lib and prog make roles.


\vfill\pagebreak
\subsection{Role-File include.mk}

\subsubsection{Purpose}

The purpose of the include role is to install the local include-files
into the local install-tree or into the drops install-tree. The
role-file achieves two goals when managing include-files:
\begin{enumerate}
\item The path where the include-files are to be found in is entirely
  defined by the package name and the target system of the
  include-files.
\item Once written, the makefile needs not to be modified, even if new
  include files are added or old include files are removed from the package.
\end{enumerate}

The target system of an include file is determined by putting it into
a specific subdirectory. The role-file will install it accordingly
then. The following table defines the subdirectories depending on the
target systems.

\begin{center}
\begin{tabular}{|l|l|}
  \hline
  if the include-file is designated for \dots
                        & put it into \dots{} or subdirectories
                        thereof
                          \rule[-.5ex]{0mm}{3ex}\\\hline\hline
  any system            & ./ \\\hline

  CPU architecture «<arch>» &
                          «ARCH-<arch>/» \\\hline

  CPU architecture «<arch>» and L4API «<api>» &
                          «ARCH-<arch>/L4API-<api>/»
                          \\\hline
\end{tabular}
\end{center}
\vspace{2ex}

%We achieve these goals by placing the include files in specific
%subdirectories and let the role-file do the rest. If an include-file
%is designated for a specific CPU architecture «<arch>», it has to be placed
%in a subdirectory named «ARCH-<arch>». It additionally the include-file is
%designated for a specific L4API «<api>», it has to be placed in a subdirectory
%named «L4API-<api>» within the architecture-dependent subdirectory. If
%the include-file is independent of any system, it has to be placed
%within the include-directory directly. In each directory, the author
%of the packet can create subdirectories and place additional
%include-files therein. They will be installed accordingly, respecting
%possible system specifications.

The installation paths are determined according to the following
table:

\latexhtml{
\begin{tabular}{|p{.265\tabTwo}|p{.735\tabTwo}|}
}{\begin{tabular}{|l|l|}}
  \hline
  \bf Designated system & \bf Local and global installation paths 
                              \rule[-.5ex]{0mm}{3ex}\\\hline\hline
  no system dependency  & «§(L4DIR)/include/l4/§(PKGNAME)/», \linebreak
                          «§(DROPS_STDDIR)/include/l4/§(PKGNAME)/» \\\hline

  CPU architecture «<arch>» &
                          «§(L4DIR)/include/<arch>/l4/§(PKGNAME)/», \linebreak
                          «§(DROPS_STDDIR)/include/<arch>/l4/§(PKGNAME)/»
                          \\\hline
  CPU architecture «<arch>» and L4API «<api>» &
                          «§(L4DIR)/include/<arch>/<api>/l4/§(PKGNAME)/»,
                          \linebreak
                          «§(DROPS_STDDIR)/include/<arch>/<api>/l4/§(PKGNAME)»
                          \\\hline
\end{tabular}


\subsubsection{Make-Targets}

\begin{description}
\item [all::] Phony target. Install all header-files found in this
  directory-tree into the local install-tree.
\item [install::] Phony target. Install all header-files found in this
  directory-tree into the global install-tree.
\end{description}

\subsubsection{Optional Parameters}

\begin{parameterlist}{INSTALLFILE_INC_LOCAL}
   INSTALLDIR_INC      & \index{§(INSTALLDIR_INC)}%
                        The directory in the global install tree to
                        install an include to.
                        Default: «§(DROPS_STDDIR)/include/» \#

   INSTALLDIR_INC_LOCAL &
                        \index{§(INSTALLDIR_INC_LOCAL)}%
                        The directory in the local install tree to
                        install an include to.
                        Default: «§(L4DIR)/include/» \#

   INSTALL_INC_PREFIX & \index{§(INSTALL_INC_PREFIX)}%
                        The prefix of installed files.
                        Think twice before changing this, as it
                        pollutes the name space of include files.
                        Default: «l4/§(PKGNAME)» \#

   PKGNAME             & \index{§(PKGNAME)}%
                        The name of the package. Default value is
                        determined from the name of the
                        package directory. \#

   TARGET              & \index{§(TARGET)}%
                        The list of file to install on
                        \textbf{all::} or \textbf{install::}. Default:
                        all «*.h»-files found in the subdirectory tree.\#


\end{parameterlist}

\subsubsection{Example}
\begin{verbatim}
PKGDIR = ..
L4DIR ?= §(PKGDIR)/../..
include §(L4DIR)/mk/include.mk
\end{verbatim}

\subsubsection{How to use the Include Role}

Note, that all include files found in the subdirectory tree are
subject to installation.

Generally, you would insert an include file with no system dependency,
hence directly into the «include/» directory. Admittedly, this may
result in a wrong compilation if you use this include file with a
system target it was not intended for. But, as no library is available
for that system target, the linker should catch this wrong package use
later.

If you realize later that you need different versions of the include
file to support different systems, you can move the include files into
appropriate subdirectories. The dependencies of the make system ensure
that no old include files will be used: Files in system-dependent
subdirectories will be found first when the preprocessor is looking
for include files. Moreover, the symbolic links in the local
installation directory «§(L4DIR)/include/» will become invalid, so
that an undesired use of them is avoided safely.


\vfill\pagebreak
\subsection{Role-File subdir.mk}

\subsubsection{Purpose}

The purpose of the subdir role is to be a container for other
directories and recursively build them. Therefore, most make-targets
are recursively forwarded to subdirectories.

\subsubsection{Make-Targets}

\begin{description}
\item [install::] Phony target. Builds the targets in the given subdirs
                in «§(TARGET)» using «make -C». Calls
                «make install» in the subdirs then.

\item [all::, clean::, cleanall::, install::, oldconfig::, 
                scrub::, txtconfig::] Phony targets. Call
                «make \{all, clean, cleanall, install,
                  oldconfig, txtconfig, scrub\}» in the
                subdirectories.

\item [config::] Phony target. Does nothing.


\end{description}

\subsubsection{Required Parameters}

\begin{parameterlist}{PKGDIR}
    PKGDIR              & \index{§(PKGDIR)}%
                          If ``.'', additional dependencies are
                          defined. If Makefiles in «idl» and «include» exist,
                          «include» depends on «idl». If Makefiles in
                          «include» and «lib» resp. «server» exist,
                          «lib» resp. «server» depend on «include».
                          \#
\end{parameterlist}

\subsubsection{Optional Parameters}

\begin{parameterlist}{MKFLAGS+}
    TARGET              & \index{§(TARGET)}%
                          List of subdirectories to build. The
                          build-order is unspecified unless other make
                          dependencies apply. Default: a list of
                          selected subdirectories that contain a
                          Makefile. If «PKGDIR» is "." the default selection
                          contains «idl, include, src, lib, server,
                          examples, doc». If «PKGDIR» is not ".", «include»
                          is not in the default list. \#

    MKFLAGS+            & \index{§(MKFLAGS+)}%
                          This value is passed to make when building a
                          subdir. Default: empty. \#

\end{parameterlist}


\subsubsection{Example}

\begin{verbatim}
PKGDIR = ..
L4DIR ?= $(PKGDIR)/../..

TARGET = example1 easy complex
include $(L4DIR)/mk/subdir.mk
\end{verbatim}


\vfill\pagebreak
\subsection{Role-File doc.mk}

Use the doc role to create doxygen documentation related to a package
or to compile latex files.

\subsubsection{Doxygen support}

The doc role allows to generate multiple documentations using doxygen,
e.g. an API documentation, an internal documentation and a
documentation of the usage of your server. For each documentation,
pick a unique name beginning with the name of the package you are
writing the documentation for. Save the doxygen files using these
names, with the «.cfg» extension added. Ensure all configurations
build into a subdir with the name of that documentation. List the
configuration files within the «SRC_DOX_*» variables. A «make~all» will
create the documentation and optionally install the html files into
«§(L4DIR)/doc/html/». With the make-file located in this directory,
you can build an index to the documentation of all DROPS packages then.

The dependency mechanism detects all changes in your source files.

Doxygen support allows to group your documentation into one of four
groups: user guides, reference manuals, internal documentation and the
rest. This classification is used when generating the index page in 
«§(L4DIR)/doc/html/».

\subsubsection{Latex support}

The doc role provides rules to compile \LaTeX{} files into .ps and
.pdf, and to convert xfig images to eps. List the .tex files you want
to be compiled in the «SRC_TEX» variable. The first file in the
«§(SRC_TEX)» is the \emph{primary tex document}. The compiled version
of the primary tex document is easily showed by calling the "showdvi"
or the "showps" target. To rebuild the primary tex document, call
"«make~dvi»" or "«make~ps»". A successful compilation triggers a
redraw within the appropriate viewer.

\subsubsection{Make-Targets}

\begin{description}
\item [all::] Phony target. Generate documentation and install it locally.

\item [install::] Phony target. Generate documentation and install it globally.

\item [dvi::, ps::, pdf::] Phony targets. Compile the primary tex document
                    into dvi and ps, respectively.

\item [showdvi::, showps::, showpdf::] Phony targets. Invoke a viewer on the
                    compiled version of the primary tex document.

\item [clean::]  Delete intermediate compilation files.

\item [cleanall::] Delete all generated files.

\end{description}

\subsubsection{Optional Parameters}

\begin{parameterlist}{SRC_DOX_GUIDE}
    DOXY_FLAGS+         & \index{§(DOXY_FLAGS)}%
                          Semicolon-separated list of additional flags
                          for doxygen. Should be set in Makecond.local to
                          enable/disable warnings and status output.
                          Default: empty.

                          Note: All semicolons are removed, no escaping!\#
                          
    SRC_DOX             & \index{§(SRC_DOX)}%
                          List of \textsl{doxygen} configuration files
                          that will be compiled using doxygen. The
                          files should end on «.cfg» and should build
                          into a directory with the same name and the
                          «.cfg» removed. \#

    SRC_DOX_GUIDE         & \index{§(SRC_DOX_INT)}%
                          As §(SRC_DOX). Documentation will be
                          classified as user guide. \#
                          
    SRC_DOX_INT         & \index{§(SRC_DOX_INT)}%
                          As §(SRC_DOX). Documentation will be
                          classified as internal. \#
                          
    SRC_DOX_REF         & \index{§(SRC_DOX_INT)}%
                          As §(SRC_DOX). Documentation will be
                          classified as reference manual. \#

    SRC_TEX             & \index{§(SRC_TEX)}%
                          List of \LaTeX{} files that will be compiled
                          into postscript files.\#

\end{parameterlist}


\subsubsection{Example}

\begin{verbatim}
PKGDIR = ..
L4DIR ?= $(PKGDIR)/../..

SRC_DOX_REF = dm_phys.cfg
include $(L4DIR)/mk/doc.mk
\end{verbatim}


\vfill\pagebreak
\subsection{Role-File runux.mk}

\subsubsection{Purpose}

Use the ptest (runux) role to run 'automated' tests on your package.

This role runs Fiasco-UX with the specified server and test-application
and compares the generated output with expected output. If the output does
not match a message is displayed and the build process is interrupted.

You may also trigger this test run in the «l4/pkg» directory by issuing
«make~ptest».

\subsubsection{Make-Targets}

\begin{description}
\item [all::] Phony target. Runs Fiasco UX with given arguments and compares
              output to expected output.

\item [ptest::]    Phony target. Same as all.

\item [genexp::]   Phony target. Generate the expected output.

\item [plainrun::] Phony target. Simply runs Fiasco UX with given arguments.
                   No watchdog is installed, no output filtering applied, and
		   no output comparison.

\item [clean::]    Delete intermediate compilation files.

\item [cleanall::] Delete all generated files (also the expected output file
                   if generated by make).

\end{description}

\subsubsection{Required Parameters}

\begin{parameterlist}{TEST_SERVER}
    TEST_SERVER		& \index{§(TEST_SERVER)}%
    			  The name of the binary to be run as the server 
			  to be tested.  If this binary name contains no
			  directory elements ('/'), then the binary is 
			  assumed to be in the architecture's and L4 API's
			  binary directory. §(L4DIR)/bin/§(ARCH)/§(L4API)

			  If there are directory elements, is used as is.
			  
			  If empty, a warning is issued and make terminates
			  successfully.\#

\end{parameterlist}

\subsubsection{Optional Parameters}

% argument of parameter-list is widest parameter
\begin{parameterlist}{REQUIRED_SERVERS}

    TEST_CLIENT		& \index{§(TEST_CLIENT)}%
    			  The name of the binary to be run as the application
			  testing the server.  Same naming rules apply as
			  with TEST_SERVER.\#

    FIASCOUX_<api>	& \index{§(FIASCOUX_<api>)}%
    			  The Fiasco-UX binary to use for the specified
			  §(L4API) 
			  Default: §(L4DIR)/kernel/fiasco/build-ux-§(L4API) 
			  (with «l4» removed from §(L4API)).\#

    BASE_SERVERS	& \index{§(BASE_SERVERS)}%
    			  The binary names of the base servers required to run
			  the test server.
			  Default: «log names dm_phys»

			  If this variable does not contain directory parts
			  ('/'), then it is prefixed with the binary directory
			  of user-land executables.  Otherwise it is taken as
			  is.

			  The binaries are then prefixed with «-l» to run as
			  modules of Fiasco-UX.\#

    EXPECTED_OUT	& \index{§(EXPECTED_OUT)}%
    			  The name of the file to contain the expected output
			  of the test-run.  This file is compared to the
			  output generated in the test-run using «diff».
			  Default: «expected.txt».

			  If not specified, the file can be generated by
			  running make with the target «genexp».  This will
			  also create another file to indicate that the
			  expected output file has been generated.  It will
			  then be deleted when running «make cleanall».
			  
			  Note: Because the test is run in an OBJ directory,
			  this should be relative to the OBJ directory (e.g.,
			  «../expected.txt»).\#

    TIMEOUT		& \index{§(TIMEOUT)}%
    			  The timeout the watchdog waits for Fiasco-UX before
			  killing it.  This is the safe-guard for
			  test-applications which do not shut down Fiasco-UX
			  themselves or if Fiasco-UX jumps into the
			  kernel-debugger.

			  The time is specified in seconds.
			  Default: 10.\#

    DEBUG_PERL		& \index{§(DEBUG_PERL)}%
    			  If the Perl-script used to run Fiasco-UX with a
			  watchdog is doing something wrong, you may set this
			  variable to 1 to get some debugging output.
			  Default: 0.\#

    SYSTEMS		& \index{§(SYSTEMS)}%
    			  Specify the systems to run this test for. This
			  determines the §(ARCH) and §(API) variable used to
			  find the user-land binaries in the «l4/bin»
			  directory.\#

    EXPECT_FAIL		& \index{§(EXPECT_FAIL)}%
    			  If set will accept failure of output comparison. If
			  output matches expected output, an error will be
			  issued. This option has no effect in generate
			  mode.\#

    FILTER_KEEP_ALL	& \index{§(FILTER_KEEP_ALL)}%
    			  If set, the output of Fiasco UX will not be
			  filtered.\#

    COMPARE_CMD		& \index{§(COMPARE_CMD)}%
    			  If set, this command is run instead of the default
			  command. This command should only generate output if
			  there is an error. If no output is generated by the
			  command, success is assumed. In case of an error the
			  last 1000 lines of the output are printed to stderr.

			  Default: diff -u §(EXPECTED_OUT) §(TMP_OUT)\#

    NO_FBUF_DEV		& \index{§(NO_FBUF_DEV)}%
    			  If set, Fiasco UX will not open a window to display
			  graphical output. This is only relevant if your
			  setup does graphical output and you would like to
			  test it in batched mode (no DISPLAY).\#

    USE_SYMBOLS		& \index{§(USE_SYMBOLS)}%
			  If set to 'y', Fiasco UX will load its Symbols. This
			  helps when debugging. Default: 'y'.\#

    USE_LINES		& \index{§(USE_LINES)}%
    			  If set to 'y', Fiasco UX will load its Lines. This
			  helps when debugging. Default: 'y'.\#
    
\end{parameterlist}


\subsubsection{Example}

\begin{verbatim}
PKGDIR = ..
L4DIR ?= $(PKGDIR)/../..

EXPECTED = ../expected.txt

TEST_SERVER = dice_hello_server
TEST_CLIENT = dice_hello_client

include $(L4DIR)/mk/runux.mk
\end{verbatim}

The §(COMPARE_CMD) can be used to apply own filter rules as well. An example
that sorts the output depending on the LOG tag is the following:

\begin{verbatim}
COMPARE_CMD = "cat $(TMP_OUT)|sort -t '|' -k1,1 -s >$(TMP_OUT) ; diff -u
$(EXPECTED_OUT) $(TMP_OUT)"
\end{verbatim}


\vfill\pagebreak

\section{Reserved variables}

When using BID, the following Make-variables are reserved besides the
one already mentioned ('«*»' denotes 'any string'):

«BID*, CARCHFLAGS_*, currentdothfile, DEPEND_EXTEND_CMD, DEPEND_EXTEND_FUNC,
DEPEND_FLAG, DEPS, DEPSNULL, DEPSVAR, DIR_FROM_SUB, FILTER_SYSTEM,
IDL_INCLUDES,
INSTALL_TARGET, INSTALL_TARGET_LOCAL, INSTALL_TARGET_GLOBAL, LIBDEPS,
MAKEDEP, OSYSTEMS, ROLE, SYSTEM_TO_ARCH, SYSTEM_TO_CPU,
SYSTEM_TO_L4API, TARGET_SYSTEMS»



\appendix

{ %begin{latexonly}
    \section{\refname}
    \renewcommand{\section}[2]{}
    \footnotesize
  %end{latexonly}
  \bibliographystyle{plain} %alpha}
  \bibliography{own}
}


\vfill\pagebreak
\section{Configuration Language}
\index{Configuration Language}
This section describes the Configuration Language to be used to write
the configuration definition files of DROPS packages.

As the drops configuration tool is inherited from the Linux Kernel
Configuration Tool, the Configuration Language is the same. Hence, the
text is that of the Linux-Kernel, version 2.4.18.


\input{config-language}

\printindex

\end{document}


% Localwords: CVS unset API APIs IDL gcc libc
% Local variables:
%  compile-command: "make"
% End:
